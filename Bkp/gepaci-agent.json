{
  "name": "gepaci-agent",
  "nodes": [
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5.1",
          "mode": "list",
          "cachedResultName": "gpt-5.1"
        },
        "options": {
          "temperature": 0.7
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3152,
        1504
      ],
      "id": "1cfe5519-3c47-4768-bd10-e5e25a5ad5fc",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "HIV493e91Mlq2ZRT",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "content": "Tools e Memory",
        "height": 352,
        "width": 688,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2976,
        1424
      ],
      "typeVersion": 1,
      "id": "d115af5c-4b64-4c25-ae5a-1f1755032ef3",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.4
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2992,
        1584
      ],
      "id": "d1b61362-bd8e-4c6a-a021-d7b6ba4df48e",
      "name": "Google Gemini Chat Atendimento",
      "credentials": {
        "googlePalmApi": {
          "id": "oGRdmFIGj3kd3Pmo",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "content": "Tools e Memory",
        "height": 1536,
        "width": 1488,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2368,
        -176
      ],
      "typeVersion": 1,
      "id": "37cb17f1-a86c-435f-b5c6-07f8964a7b01",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensagemAtual }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "**INSTRUÇÕES PARA COLETA DE IDENTIFICAÇAO DA AGENTE \"Gê**\n\nVocê é a **Gê**, atendente virtual do **Gepaci**. Sua função nessa etapa será somente solicitar, coletar e validar se a informação passada pelo usuário é uma matricula/RE (contendo 6 dígitos) ou um CPF (contendo no máximo 11 dígitos)\n\n\n### 1. **Estilo de Atendimento**\n\n* Seja sempre **educada**, **objetiva**, **compreensiva** e **empática**.\n* Mantenha um tom **humanizado e acolhedor**.\n* Faça **apenas uma pergunta por vez**. Nunca sobrecarregue o cliente com múltiplas perguntas simultâneas.\n* **Nunca utilize informações externas** as orientações desse script\n\n### 2. **Início da Conversa**\n\n1. Inicie a conversa se apresentando cordialmente dependendo do **horário atual: {{ $now }}**. Apresente-se de forma simpática como Gê, atendente virtual do Gepaci.\n2. Pergunte qual é a **Matricula/RE** (contendo 6 dígitos) caso seja um funcionário Icomon ou o **CPF** em caso de Ex-Funcionário.\n3. Valide se a informação passada possui o número de dígitos informado. Caso positivo, passe para o proximo nó.\n4. Se a informação passada não atender aos requisitos, solicite os dados novamente.\n5. ATENÇÃO: Você não deve apresentar fórmulas ou códigos na conversa.\n\n*Aguarde a resposta de cada pergunta antes de seguir para a próxima.*\n\n### 3. **Encerramento da Conversa**\n\nSe o colaborados não for localizado após duas tentativas ou se o mesmo informar que não é um funcionário ou ex-funcionário, finalize a conversa chamando o Agent Tool **AI Nao Localizado**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3152,
        -80
      ],
      "id": "de3f9608-3922-477d-be4b-cf8e16ef2bd1",
      "name": "Validar Usuario",
      "notesInFlow": false,
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Coletar Mensagem Atendimento').item.json.mensagemAtual }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=**INSTRUÇÕES GERAIS PARA O AGENTE \"Gê\"**\n\nVocê é a **Gê**, atendente virtual do **Gepaci** da empresa *Icomon*, especializada em fornecer informações sobre os processos de gestão de pessoas e também realizar o direcionamento do atendimento em casos específicos de **alteração de conta ou de tipo de benefício**.\n\n### 1. **Estilo de Atendimento**\n\n* Seja sempre **educada**, **objetiva**, **compreensiva** e **empática**.\n* Mantenha um tom **humanizado e acolhedor**.\n* Faça **apenas uma pergunta por vez**. Nunca sobrecarregue o usuário com múltiplas perguntas simultâneas.\n* **Nunca utilize informações externas** ao conteúdo da **Tool Banco Verorial** aplicada na Tools.\n* Você tem autonomia para alterar as frases do Script e da base de conhecimentos, mas sem perder o sentido da informação.\n\n### 2. **Início da Conversa**\n\n1. Consulte o histórico da conversa no Redis Memory. Se a saudação já foi realizada por outro agente você deverá somente perguntar em que pode ajudar e chamando o usuário pela primeira parte do nome **{{ $json.nomeUsuario }}** e siga o atendimento.\n2. Caso você seja o primeiro agente a abordar o usuário, inicie a conversa se apresentando cordialmente e com um \"Bom dia/Boa tarde/Boa noite\" dependendo do **horário atual: {{ $now }}**. Chame o usuário pela primeira parte do nome **{{ $json.nomeUsuario }}** e pergunte em que pode ajudar.\n3. Exemplos de frases para apresentação: \"Prazer **{{ $json.nomeUsuario }}** (somente o primeiro nome) eu sou a Gê, sua agente virtual e será um privilégio te ajudar. Para qual assunto posso te auxiliar?\".\n4. ATENÇÃO: Não apresente os dados pessoas como senha e logins nas suas respostas.\n5. ATENÇÃO: O nome do usuário deve ser usado somente na apresentação ou em alguns casos que achar necessário. Você não deve utiliza-lo em toda resposta que enviar.\n6. Nesse ponto você não precisa solicitar os dados do usuário. Todos eles já foram coletados no banco de dados e podem ser utilizados na conversa, caso necessário.\n7. ATENÇÃO: Utilize sempre mensagens curtas (de no máximo 3 linhas) para que o usuário possa acompanhar o dialogo como uma conversa normal com um humano.\n8. Se o assunto solicitado pelo usuário tiver mais tópicos e a pergunta foi muito abrangente, tente sondar quais informações o usuário precisa para que seja mais preciso na resposta. Exemplos: \n  - Assunto cancelamento de ingressos: Você deve perguntar ao usuário quais ingressos ele deseja cancelar.\n  - Assunto plano de Saúde> Você deve questionar quais informações sobre Plano de Saúde o usuário necessita.\n9. Nunca envie a documentação inteira para o usuário. Somente os pontos solicitados.\n10. Não repita informações já passadas. Apenas complemente as informações.\n11. ATENÇÃO: Não apresente os dados pessoas como senha e logins nas suas respostas.\n12. ATENÇÃO: Você não deve apresentar fórmulas ou códigos na conversa.\n\n*Aguarde a resposta de cada pergunta antes de seguir para a próxima.*\n\n### 4. **Alteração de conta ou de tipo de benefício**\n\n1. Para esse tipo de solicitação você deve acionar a Tools do Redis para alterar o status de atendimento e depois encaminhar o usuário para que o AI Agent Tools **AI Acessos IcoPass** de sequência ao atendimento.\n2. Nesse ponto você não deve responder ao usuário. Acione diretamente o agente para que ele siga com a conversa.\n3. Se o usuário errar o token o atendimento será encaminhado para você novamente. Você deve analisar o histórico da conversa, acionar a Tools do Redis para alterar o status de atendimento novamente e depois encaminhar o usuário para que o AI Agent Tools **AI Acessos IcoPass** de sequência ao atendimento.\n\n### 4. **Uso da Base de Conhecimento**\n\n* Utilize as respostas fornecidas pelo cliente para consultar a **Tool Banco Verorial**.\n* Com base nessas informações, apresente **soluções** relevantes os questionamentos ou dúvidas do usuário.\n* Você deve apresentar somente as informações relevantes a solicitação do cliente. Exemplo: \"Informação sobre Ingressos Cinemark\". Você deve somente as informações referentes a esse benefício.\n* Seja **objetiva**, mas mantenha o foco no que for útil e aplicável.\n* **Nunca ofereça nada fora da Tool Banco Verorial**.\n\n  > Caso o cliente solicite algo fora da base, **peça desculpas** e pergunte se deseja falar com um especialista.\n  > Se insistir, explique gentilmente a limitação e, se necessário, **encerre educadamente a conversa**.\n\n### 5. **Sobre o Funcionamento de Agentes de IA**\n\n* Se questionada sobre como funciona um Agentes de IA, explique que **você é um exemplo real**, treinado com informações do **Gepaci**, e capaz de atender de forma automatizada e inteligente.\n\n### 6. **Cases de Sucesso**\n\n* Utilize os exemplos disponíveis na **Tool Banco Verorial**.\n* **Jamais divulgue nomes de clientes**, respeitando a **confidencialidade**.\n\n### 7. **Encerramento do Atendimento**\n\n* Agradeça e encerre o atendimento cordialmente.\n\n### 8. **Uso do Bloco `<Tool Banco Verorial>`**\n\nSempre que precisar fornecer informações, **consulte apenas este bloco**.\nSe a informação não estiver presente, **não invente**."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3152,
        576
      ],
      "id": "c60593fd-4d71-4623-967e-6683f8bbb20c",
      "name": "Atendimento",
      "notesInFlow": false,
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9efad99d-7bde-414c-af1a-637e4d123fb5",
              "name": "inputIdentity",
              "value": "={{ $('Tratar somente Numeros').item.json.messageOnlyNumbers }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1792,
        -112
      ],
      "id": "2b2c80d6-2392-45d7-a8f7-18be5ba4879a",
      "name": "coletar identificador",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/db-contas",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "json.phoneNumber",
              "value": "={{ $('coletar dados da conversa').item.json.phoneNumber }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        336,
        352
      ],
      "id": "d130a352-e2c8-464d-a9ab-d06feb757ab2",
      "name": "Sql Agtesla",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9efad99d-7bde-414c-af1a-637e4d123fb5",
              "name": "dadosCliente.Nome",
              "value": "={{ $('Sql Agtesla').item.json.body.NOME_SCL }}",
              "type": "string"
            },
            {
              "id": "b4057371-72ff-4f0b-8cea-80002b90a3a2",
              "name": "dadosCliente.Re",
              "value": "={{ $('Sql Agtesla').item.json.body.RE_SCL }}",
              "type": "string"
            },
            {
              "id": "97d8db74-5db5-4924-b230-20718dc5805b",
              "name": "dadosCliente.Status",
              "value": "={{ $('Sql Agtesla').item.json.body.STATUS_SCL }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        128,
        624
      ],
      "id": "aec2052a-2e61-4928-ab3a-18c969e424e9",
      "name": "coletar dados usuario",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec732077-a790-418b-a4f4-7fceeef216e2",
              "leftValue": "={{ $json.messageOnlyNumbers }}",
              "rightValue": "^[0-9]{6}$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            },
            {
              "id": "60536cd9-5339-4560-a516-39d523053786",
              "leftValue": "={{ $json.messageOnlyNumbers }}",
              "rightValue": "^[0-9]{11}$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1552,
        -48
      ],
      "id": "8703ea24-fae3-4943-b1ca-c037df784a46",
      "name": "If"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatswebhook",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1168,
        -80
      ],
      "id": "78b3644e-b490-4a61-8af9-efa209ea77ce",
      "name": "Webhook",
      "webhookId": "f64d0604-db70-4a3f-8315-9a9719001fb7"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        3488,
        1520
      ],
      "id": "3ba12f01-7c85-4d12-b5a6-19f2e07dc116",
      "name": "Think"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "21b073af-b386-45de-bc4b-6cbf2e2aee20",
              "leftValue": "={{ $json.statusAtendimento }}",
              "rightValue": "=",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1008,
        96
      ],
      "id": "8d0d89ed-8c1d-4c17-a9e7-48a029c5caef",
      "name": "If2",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b60e9583-6fe9-45ff-ac2f-aadaaa27c51f",
              "name": "session",
              "value": "={{ $('Webhook').item.json.body.session }}",
              "type": "string"
            },
            {
              "id": "1f37ee26-a963-497c-b693-a14afd0bdff1",
              "name": "chatId",
              "value": "={{ $('Webhook').item.json.body.chatId }}",
              "type": "string"
            },
            {
              "id": "01a74efd-5d4e-4869-b157-8611c12facf8",
              "name": "pushName",
              "value": "={{ $('Webhook').item.json.body.pushName }}",
              "type": "string"
            },
            {
              "id": "ee194e95-3390-43ba-8f4c-e5ad1054b4d6",
              "name": "payload_id",
              "value": "={{ $('Webhook').item.json.body.payload_id }}",
              "type": "string"
            },
            {
              "id": "36b91569-2721-46ab-b458-6c2c00c1f659",
              "name": "event",
              "value": "={{ $('Webhook').item.json.body.event }}",
              "type": "string"
            },
            {
              "id": "384c4862-3a8c-4c1f-a28f-2dad32b1fb75",
              "name": "fromMe",
              "value": "={{ $('Webhook').item.json.body.fromMe }}",
              "type": "string"
            },
            {
              "id": "6c3fee67-5a3e-4daf-b7e0-8a987bf24dc1",
              "name": "message",
              "value": "={{ $('Set Buffer Mensagens').item.json.messageBuffer }}",
              "type": "string"
            },
            {
              "id": "c06f028b-6543-451e-ab4c-ef99e6feea7d",
              "name": "phoneNumber",
              "value": "={{ $json.foneTratado }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        272,
        -112
      ],
      "id": "ff637e42-0e66-4e1f-8097-c95881c72a19",
      "name": "coletar dados da conversa",
      "executeOnce": true
    },
    {
      "parameters": {
        "content": "Consultar Bando db_contas",
        "height": 592,
        "width": 784
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        16,
        272
      ],
      "typeVersion": 1,
      "id": "ff2c1416-3cef-443c-bd9f-36c4cc01cd78",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "21b073af-b386-45de-bc4b-6cbf2e2aee20",
              "leftValue": "={{ $json.body.ID }}",
              "rightValue": 200,
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        544,
        352
      ],
      "id": "2f7762bc-218e-4643-b1c4-0cd6579f5a92",
      "name": "If3",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "\nconst whatsapp = $('Webhook').first().json.body.contacts[0].phones[0].phone;\nconst onlyPhone = whatsapp\n  .replace(/\\D/g, '')\n  .replace(/^55/, '');\nconst result = [\n  {\n    foneTratado: onlyPhone\n  }\n];\n\nreturn result;\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        -112
      ],
      "id": "19859430-1c5e-47e7-aa85-887c6407d97b",
      "name": "Tratar número",
      "alwaysOutputData": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "Inicio",
        "height": 400,
        "width": 784,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        16,
        -160
      ],
      "typeVersion": 1,
      "id": "47e1cb6e-ed09-484d-ad65-3e481a7ceea2",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "Consulta API Funcionarios",
        "height": 688,
        "width": 864
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1456,
        -176
      ],
      "typeVersion": 1,
      "id": "a0a6a929-04c2-478d-abc2-47c69bfc8258",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "statusAtendimento",
        "key": "={{ $json.session }}",
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        80,
        96
      ],
      "id": "3e6c5947-dd4f-4b12-aaa1-713196a59e4d",
      "name": "Consultar Status",
      "alwaysOutputData": false,
      "notesInFlow": false,
      "executeOnce": false,
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 120,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('Webhook').item.json.body.session }}",
        "value": "inicio_conversa",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        128,
        352
      ],
      "id": "f4ccd57c-2201-4134-940e-d941b03f8a6f",
      "name": "Setar Status Inicial",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "statusAtendimento",
        "key": "={{ $('coletar dados da conversa').item.json.session }}",
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1008,
        528
      ],
      "id": "c7aeef34-6091-472f-8c1b-fc08c7f98f9f",
      "name": "Status direcionamento",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "08f1353f-0d65-46cd-9613-78a2304040d9",
                    "leftValue": "={{ $json.statusAtendimento }}",
                    "rightValue": "inicio_conversa",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "verificar_usuario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "57b50e12-5a8c-4ef1-b842-05557744c30d",
                    "leftValue": "={{ $json.statusAtendimento }}",
                    "rightValue": "nao_localizado",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "=nao_localizado"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f1eeb533-409f-409b-bebd-b35ca3bb6c54",
                    "leftValue": "={{ $json.statusAtendimento }}",
                    "rightValue": "atendimento",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "atendimento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f3743f36-1131-45b3-9d33-ced97cbf2c57",
                    "leftValue": "={{ $json.statusAtendimento }}",
                    "rightValue": "acesso_icopass",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "validar_icopass"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3735b938-34a3-4117-9b89-561d09ee2e1b",
                    "leftValue": "={{ $json.statusAtendimento }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notExists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "finalizar"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1248,
        480
      ],
      "id": "852561e2-c0f4-4ea6-8096-38f3ca073d82",
      "name": "Gerenciar direcionamento"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Webhook').item.json.body.session }}_{{ $('Webhook').item.json.body.chatId }}",
        "sessionTTL": 1200,
        "contextWindowLength": 40
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        3312,
        1616
      ],
      "id": "ddeb4837-1477-46bc-b1b1-867e7af0aca2",
      "name": "Redis Chat Memory",
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('Webhook').item.json.body.session }}_message",
        "value": "={{ $('Webhook').item.json.body.message }}",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        288,
        96
      ],
      "id": "1004f89f-5817-4f05-b2cf-f44aa9e980f7",
      "name": "Mensagem atual",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "batchSize": 3,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3616,
        304
      ],
      "id": "72096b6b-7e38-4d8f-8df8-1b563447c15a",
      "name": "Loop Over Items"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me",
      "typeVersion": 1,
      "position": [
        3872,
        320
      ],
      "id": "89f03713-7a00-42a4-8c5b-bb8b5e48abe4"
    },
    {
      "parameters": {
        "content": "Direcionamentos\n",
        "height": 1200,
        "width": 592,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        832,
        -160
      ],
      "typeVersion": 1,
      "id": "09c13244-9ae9-4484-a549-99bea77b5580",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "341efbfa-c910-48de-8435-deda0b23ea41",
              "leftValue": "={{ $('API Identidade').item.json.statusCode }}",
              "rightValue": 200,
              "operator": {
                "type": "number",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1776,
        96
      ],
      "id": "64859877-2444-4e3a-821d-da9cb9da53b0",
      "name": "If1"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('Webhook').item.json.body.session }}",
        "value": "nao_localizado",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2000,
        80
      ],
      "id": "dd060372-3177-439c-af2d-1319afa30f58",
      "name": "Setar Status Nao Localizado",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('Webhook').item.json.body.session }}",
        "value": "atendimento",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1776,
        304
      ],
      "id": "c1369551-1f28-4d21-b5c4-20304a9701cc",
      "name": "Setar Status Atendimento",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensagemAtual }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "**INSTRUÇÕES PARA COLABORADOR NÃO ENCONTRADO NA BASE**\n\nVocê é a **Gê**, atendente virtual do **Gepaci**. Sua função nessa etapa será para somente para orientar o usuário a entrar em contato com os canais de atendimento adequados.\n\n\n### 1. **Estilo de Atendimento**\n\n* Seja sempre **educada**, **objetiva**, **compreensiva** e **empática**.\n* Mantenha um tom **humanizado e acolhedor**.\n* Faça **apenas uma pergunta por vez**. Nunca sobrecarregue o cliente com múltiplas perguntas simultâneas.\n* **Nunca utilize informações externas** as orientações desse script\n\n### 2. **Início da Conversa**\n\n1. O atendimento já foi iniciado em outro momento e não foi possível localizar o colaborador com os dados informados.\n2. Informe que não poderá seguir com o atendimento por esse canal e oriente o mesmo a entrar em contato através do número: **0800-999-9999**.\n3. Caso o usuário insista, passe algumas orientações básicas ou oriente o mesmo a procurar seus superiores.\n\n⚠️ *Aguarde a resposta de cada pergunta antes de seguir para a próxima.*"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        3136,
        176
      ],
      "id": "0585c512-43bb-4f6e-bd1d-aa22ab74cabd",
      "name": "Colaborador Não Encontrado",
      "notesInFlow": false,
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagemAtual",
        "key": "={{ $('Webhook').item.json.body.session }}_message",
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2688,
        -64
      ],
      "id": "8e80c6d1-4df6-4874-94b7-f9121dd7ca92",
      "name": "Coletar Mensagem Verificacao",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagemAtual",
        "key": "={{ $('Webhook').item.json.body.session }}_message",
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2704,
        272
      ],
      "id": "96233dae-a9e7-4458-bdbb-062a8e819164",
      "name": "Coletar Mensagem Nao Encontrado",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagemAtual",
        "key": "={{ $('coletar dados da conversa').item.json.session }}_message",
        "options": {
          "dotNotation": false
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2704,
        576
      ],
      "id": "e42313c1-a52f-4b8f-8541-71bacf40ace8",
      "name": "Coletar Mensagem Atendimento",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').item.json.session }}",
        "value": "atendimento",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        672,
        624
      ],
      "id": "d0a39be7-4519-4602-aa7e-21c8f887dbc9",
      "name": "Setar Status Atendimento1",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').item.json.session }}_nome",
        "value": "={{ $('coletar dados usuario').item.json.dadosCliente.Nome }}",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        496,
        624
      ],
      "id": "a670ae7e-33ee-4c06-8127-27548624e6e4",
      "name": "Setar Nome",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "nomeUsuario",
        "key": "={{ $('coletar dados da conversa').item.json.session }}_nome",
        "options": {
          "dotNotation": false
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2912,
        576
      ],
      "id": "2f387d0c-bf46-4797-9407-92ed03977402",
      "name": "Coletar Nome Usuario",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').item.json.session }}_nome",
        "value": "={{ $('coletar dados usuario1').item.json.dadosCliente.Nome }}",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2000,
        304
      ],
      "id": "3763890f-2ac5-40a1-8db9-9dfc225a5098",
      "name": "Setar Nome1",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9efad99d-7bde-414c-af1a-637e4d123fb5",
              "name": "dadosCliente.Nome",
              "value": "={{ $json.body.body.nome }}",
              "type": "string"
            },
            {
              "id": "b4057371-72ff-4f0b-8cea-80002b90a3a2",
              "name": "dadosCliente.Re",
              "value": "={{ $('coletar identificador').item.json.inputIdentity }}",
              "type": "string"
            },
            {
              "id": "97d8db74-5db5-4924-b230-20718dc5805b",
              "name": "dadosCliente.Status",
              "value": "={{ $json.body.body.colaborador }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2368,
        112
      ],
      "id": "94ccc482-a866-4bd3-ba35-5291c54e862d",
      "name": "coletar dados usuario1",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "text": "**INSTRUÇÕES PARA NÃO ENCONTRADO NA BASE OU NÃO FUNCIONÁRIO**\n\nVocê é a **Gê**, atendente virtual do **Gepaci**. Sua função nessa etapa será para somente para orientar o usuário a entrar em contato com os canais de atendimento adequados.\n\n\n### 1. **Estilo de Atendimento**\n\n* Seja sempre **educada**, **objetiva**, **compreensiva** e **empática**.\n* Mantenha um tom **humanizado e acolhedor**.\n* Faça **apenas uma pergunta por vez**. Nunca sobrecarregue o cliente com múltiplas perguntas simultâneas.\n* **Nunca utilize informações externas** as orientações desse script\n\n### 2. **Início da Conversa**\n\n1. O atendimento já foi iniciado em outro momento e não foi possível localizar o colaborador com os dados informados.\n2. Você receberá direcionamento de usuários que não foram localizados na base ou de pessoas que nunca trabalharam na empresa.\n3. Para pessoas que não trabalham e nunca trabalharam na Icomon, informe que esse canal é exclusivo para funcionários e ex-funcionarios e encerre o atendimento de forma amigavel.\n4. Para funcionários que não foram localizados, informe que não poderá seguir com o atendimento por esse canal e oriente o mesmo a entrar em contato através do número: **0800-999-9999**.\n5. Após passar essas informações você pode se despedir e encerrar o atendimento.",
        "needsFallback": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        3696,
        896
      ],
      "id": "376c4c5a-c4cb-43ac-9a37-f2be3096d31d",
      "name": "AI Nao Localizado"
    },
    {
      "parameters": {
        "jsCode": "\nconst mensagem = $('coletar dados da conversa').first().json.message;\nconst onlyNumbers = mensagem\n  .replace(/\\D/g, '')\nconst result = [\n  {\n    messageOnlyNumbers: onlyNumbers\n  }\n];\n\nreturn result;\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1216,
        -16
      ],
      "id": "8a12597d-a9cd-41c3-8156-02567a9e4784",
      "name": "Tratar somente Numeros",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        3088,
        1168
      ],
      "id": "86188932-15af-4d25-aabd-54d74937c56a",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "HIV493e91Mlq2ZRT",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-nano",
          "mode": "list",
          "cachedResultName": "gpt-4.1-nano"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3440,
        1136
      ],
      "id": "4df9d094-0640-4202-ab5a-c5339ddbe36b",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "HIV493e91Mlq2ZRT",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "options": {
          "queryName": "match_documents"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        3120,
        1024
      ],
      "id": "2f2ed3e1-3c04-4f63-a3fc-98a1238ae85d",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "htCf539ApNjfrbw8",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/identidade",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "json.chatInput",
              "value": "={{ $json.inputIdentity }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2064,
        -112
      ],
      "id": "0d3f3bac-06bc-44e3-a8d4-df06302cb353",
      "name": "API Identidade",
      "alwaysOutputData": false,
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 100,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/icopass",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "tokenUser",
              "value": "={{ $json.inputToken }}"
            },
            {
              "name": "matricula",
              "value": "=r999451"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2192,
        608
      ],
      "id": "e2b3254f-be29-4571-ba27-fa76816b89cd",
      "name": "API IcoPass",
      "alwaysOutputData": false,
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 100,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "text": "**INSTRUÇÕES PARA COLETA TOKEN ICOPASS**\n\nSua função será orientar o usuário a informar o token para validação de identidade do funcionário usando o APP IcoPass. \n\n\n### 1. **Estilo de Atendimento**\n\n* Seja sempre **educada**, **objetiva**, **compreensiva** e **empática**.\n* Mantenha um tom **humanizado e acolhedor**.\n* Faça **apenas uma pergunta por vez**. Nunca sobrecarregue o cliente com múltiplas perguntas simultâneas.\n* **Nunca utilize informações externas** as orientações desse script\n\n### 1. **Solicitando o Token IcoPass**\n\n1. O atendimento já foi iniciado por outro agente e você pode iniciar a abordagem sem precisar de uma saudação ou nova apresentação.\n2. Informe o usuário que o para seguir com a solicitação desejada o mesmo deve validar sua identidade informando o **ICOMON Token** gerado no app IcoPass.\n3. O acesso no app deve ser feito utilizando o *usuário* e a *senha* de rede que o mesmo utiliza para acesso ao computador.\n4. Se a informação passada não atender aos requisitos, solicite os dados novamente.\n\n*Aguarde a resposta de cada pergunta antes de seguir para a próxima.*\n\n### 3. **Encerramento da Conversa**\n\nSe o colaborados não conseguir validar o token após duas tentativas, finalize a conversa chamando o Agent Tool **AI Nao Localizado**",
        "needsFallback": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        2720,
        880
      ],
      "id": "d499bcc2-7d7c-42a3-a43b-fedf79838c30",
      "name": "AI Acessos IcoPass"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec732077-a790-418b-a4f4-7fceeef216e2",
              "leftValue": "={{ $json.messageOnlyNumbers }}",
              "rightValue": "^[0-9]{6}$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1696,
        624
      ],
      "id": "cd2ab716-b0ca-4622-b710-56f7a3f624d5",
      "name": "If IcoPass"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9efad99d-7bde-414c-af1a-637e4d123fb5",
              "name": "inputToken",
              "value": "={{ $('Tratar somente Numeros1').item.json.messageOnlyNumbers }}",
              "type": "string"
            },
            {
              "id": "995dfa0d-2e48-4fb3-9a60-087d76e3c96e",
              "name": "matriculaUsuario",
              "value": "={{ $('Coletar Matricula Usuario').item.json.matricula }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2032,
        608
      ],
      "id": "ba43b19a-9d92-4a58-b2c5-f4d17f7e3ae2",
      "name": "coletar token",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "\nconst mensagem = $('coletar dados da conversa').first().json.message;\nconst onlyNumbers = mensagem\n  .replace(/\\D/g, '')\nconst result = [\n  {\n    messageOnlyNumbers: onlyNumbers\n  }\n];\n\nreturn result;\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1536,
        624
      ],
      "id": "4a990b73-3179-47ac-b9d0-675c245b9483",
      "name": "Tratar somente Numeros1",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').item.json.session }}_matricula",
        "value": "={{ $('coletar dados usuario').item.json.dadosCliente.Re }}",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        304,
        624
      ],
      "id": "4c766add-9fb0-49b6-81ea-fcf8d7af35cf",
      "name": "Setar Matricula",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').item.json.session }}_matricula",
        "value": "={{ $('coletar dados usuario1').item.json.dadosCliente.Re }}",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2368,
        304
      ],
      "id": "d1ba5db6-0a84-4612-a502-23022bd90a93",
      "name": "Setar Matricula1",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').item.json.session }}",
        "value": "acesso_icopass",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redisTool",
      "typeVersion": 1,
      "position": [
        3408,
        864
      ],
      "id": "a433e5db-0cf1-419c-aeed-46f52bf6aef1",
      "name": "Status Icopass",
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('Webhook').item.json.body.session }}",
        "value": "nao_localizado",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2112,
        864
      ],
      "id": "f47976af-1146-45f7-9518-b648f6b3c107",
      "name": "Setar Status Nao Localizado1",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('Webhook').item.json.body.session }}",
        "value": "atendimento",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1872,
        784
      ],
      "id": "478977c8-f7aa-46da-95dc-43d166a70a7c",
      "name": "Setar Status Atendimento2",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "341efbfa-c910-48de-8435-deda0b23ea41",
              "leftValue": "={{ $('API IcoPass').item.json.statusCode }}",
              "rightValue": 200,
              "operator": {
                "type": "number",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1552,
        880
      ],
      "id": "70c2d0cb-99cd-4f5d-9da0-04b25dd8fe4d",
      "name": "If4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Token validado. Retorno da API: {{ $('API IcoPass').item.json.statusCode }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "Nesse ponto você só precisa informar ao usuário que o token foi validado e depois finalizar o atendimento se despedindo cordialmente. "
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1776,
        1072
      ],
      "id": "dc1ba906-e2b6-4c1e-be7d-6494f8445063",
      "name": "Token Valido"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('Webhook').item.json.body.session }}",
        "value": "atendimento",
        "expire": true,
        "ttl": 200
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2112,
        1072
      ],
      "id": "af7a962b-4cf8-426d-82a8-89af111c88a6",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "content": "Validar Token IcoPass",
        "height": 736,
        "width": 864
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1456,
        528
      ],
      "typeVersion": 1,
      "id": "33c54879-2c3f-433e-96d7-a1d15b313747",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "matricula",
        "key": "={{ $('coletar dados da conversa').item.json.session }}_matricula",
        "options": {
          "dotNotation": false
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1872,
        608
      ],
      "id": "fa02a1f8-fe5c-4e27-a477-1434982980ec",
      "name": "Coletar Matricula Usuario",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.rerankerCohere",
      "typeVersion": 1,
      "position": [
        3104,
        1248
      ],
      "id": "02b8da86-35be-4e98-be3f-c24c0be8aed1",
      "name": "Reranker Cohere",
      "credentials": {
        "cohereApi": {
          "id": "4K9XXxDqJVHFJDFD",
          "name": "CohereApi account"
        }
      }
    },
    {
      "parameters": {
        "description": "Contem informações para orientações ao usuário sobre serviços e benefícios ofertados pela empresa.",
        "topK": 8
      },
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1.1,
      "position": [
        3120,
        864
      ],
      "id": "ef8ae2d9-2c84-456f-b527-e1d968f580e3",
      "name": "Banco Vetorial"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{$('Coletar Msg ID').item.json.sessionId }}_buffer",
        "messageData": "={{ $('Coletar Msg ID').item.json.inputMessage}}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -688,
        -80
      ],
      "id": "1fa797f4-b027-4b8f-812a-c9bee02d12dd",
      "name": "Set Buffer Mensagem",
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 8
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -432,
        -80
      ],
      "id": "05498ecf-e895-4e6a-b62d-e5ba678f8ed8",
      "name": "Wait",
      "webhookId": "4927fddc-4044-4fbf-a7e8-3c49ec4739fe"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "37f9a613-db78-4c71-99ac-b09f483e90fd",
              "leftValue": "={{ $json.validarMensagem.last() }}",
              "rightValue": "={{ $('Coletar Msg ID').item.json.inputMessage }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -928,
        240
      ],
      "id": "3e5eadee-dd83-461e-9081-13cc5a35c74a",
      "name": "If5"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -608,
        416
      ],
      "id": "812fe15a-0814-4c07-8ebb-bfc25c4ddd82",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "validarMensagem",
        "key": "={{$('Coletar Msg ID').item.json.sessionId }}_buffer",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -208,
        -80
      ],
      "id": "6e47f74a-20b7-450e-b371-505ec99250a9",
      "name": "Coletar Buffer Mensagem",
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "dd8e3dd6-3fd4-4169-83c1-5a9941b50ede",
              "name": "messageBuffer",
              "value": "={{ $('Coletar Buffer Mensagem').item.json.validarMensagem.join('\\n') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -608,
        224
      ],
      "id": "92bee6a2-c892-4096-8710-31ecf708d7df",
      "name": "Set Buffer Mensagens"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{$('Coletar Msg ID').item.json.sessionId }}_buffer"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -336,
        224
      ],
      "id": "0340263e-76ac-415a-9371-48b6d7ab27d3",
      "name": "Delete Buffer Mensagem",
      "credentials": {
        "redis": {
          "id": "MgGckVnF4CAFHnor",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c9a6b8d5-f2f4-4ddb-bba4-16047924a289",
              "name": "inputMessage",
              "value": "={{ $json.body.message }}",
              "type": "string"
            },
            {
              "id": "23c6d005-52e1-4e41-922f-7bb53e0c901d",
              "name": "sessionId",
              "value": "={{ $json.body.session }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -960,
        -80
      ],
      "id": "cf1da910-6e93-4926-9ffb-5a8820abf518",
      "name": "Coletar Msg ID"
    },
    {
      "parameters": {
        "content": "Inicio / Buffer Mensagens",
        "height": 752,
        "width": 1216,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1248,
        -176
      ],
      "typeVersion": 1,
      "id": "5c61eb2e-0038-4e2a-a068-1066d958e94d",
      "name": "Sticky Note"
    }
  ],
  "pinData": {},
  "connections": {
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Token Valido",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "AI Acessos IcoPass",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "AI Nao Localizado",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Atendimento",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Colaborador Não Encontrado",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Validar Usuario",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "coletar identificador": {
      "main": [
        [
          {
            "node": "API Identidade",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "coletar dados usuario": {
      "main": [
        [
          {
            "node": "Setar Matricula",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "coletar identificador",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Coletar Mensagem Verificacao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Coletar Msg ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "Colaborador Não Encontrado",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Atendimento",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Validar Usuario",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "AI Nao Localizado",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "AI Acessos IcoPass",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Setar Status Inicial",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "coletar dados da conversa": {
      "main": [
        [
          {
            "node": "Consultar Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "coletar dados usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tratar número": {
      "main": [
        [
          {
            "node": "coletar dados da conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Status": {
      "main": [
        [
          {
            "node": "Mensagem atual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Status Inicial": {
      "main": [
        [
          {
            "node": "Sql Agtesla",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status direcionamento": {
      "main": [
        [
          {
            "node": "Gerenciar direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerenciar direcionamento": {
      "main": [
        [
          {
            "node": "Tratar somente Numeros",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Coletar Mensagem Nao Encontrado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Coletar Mensagem Atendimento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tratar somente Numeros1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tratar somente Numeros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Nao Localizado",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "AI Acessos IcoPass",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Token Valido",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Atendimento",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Validar Usuario",
            "type": "ai_memory",
            "index": 0
          },
          {
            "node": "Colaborador Não Encontrado",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem atual": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atendimento": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Replace Me",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Usuario": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Setar Status Nao Localizado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "coletar dados usuario1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Colaborador Não Encontrado": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Mensagem Verificacao": {
      "main": [
        [
          {
            "node": "Validar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Mensagem Nao Encontrado": {
      "main": [
        [
          {
            "node": "Colaborador Não Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Mensagem Atendimento": {
      "main": [
        [
          {
            "node": "Coletar Nome Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Status Atendimento": {
      "main": [
        [
          {
            "node": "Setar Nome1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Status Nao Localizado": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Status Atendimento1": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Nome": {
      "main": [
        [
          {
            "node": "Setar Status Atendimento1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Atendimento": {
      "ai_languageModel": [
        [
          {
            "node": "Token Valido",
            "type": "ai_languageModel",
            "index": 1
          },
          {
            "node": "AI Acessos IcoPass",
            "type": "ai_languageModel",
            "index": 1
          },
          {
            "node": "AI Nao Localizado",
            "type": "ai_languageModel",
            "index": 1
          },
          {
            "node": "Atendimento",
            "type": "ai_languageModel",
            "index": 1
          },
          {
            "node": "Colaborador Não Encontrado",
            "type": "ai_languageModel",
            "index": 1
          },
          {
            "node": "Validar Usuario",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Sql Agtesla": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Nome Usuario": {
      "main": [
        [
          {
            "node": "Atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Nome1": {
      "main": [
        [
          {
            "node": "Setar Matricula1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "coletar dados usuario1": {
      "main": [
        [
          {
            "node": "Setar Status Atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Nao Localizado": {
      "ai_tool": [
        [
          {
            "node": "Validar Usuario",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "AI Acessos IcoPass",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Tratar somente Numeros": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Banco Vetorial",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_vectorStore": [
        [
          {
            "node": "Banco Vetorial",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "API Identidade": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Acessos IcoPass": {
      "ai_tool": [
        [
          {
            "node": "Atendimento",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "If IcoPass": {
      "main": [
        [
          {
            "node": "Coletar Matricula Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Setar Status Atendimento2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tratar somente Numeros1": {
      "main": [
        [
          {
            "node": "If IcoPass",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "coletar token": {
      "main": [
        [
          {
            "node": "API IcoPass",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Matricula": {
      "main": [
        [
          {
            "node": "Setar Nome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Icopass": {
      "ai_tool": [
        [
          {
            "node": "Atendimento",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Setar Status Nao Localizado1": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API IcoPass": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Setar Status Nao Localizado1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Token Valido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Status Atendimento2": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Matricula1": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Token Valido": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Matricula Usuario": {
      "main": [
        [
          {
            "node": "coletar token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reranker Cohere": {
      "ai_reranker": [
        []
      ]
    },
    "Banco Vetorial": {
      "ai_tool": [
        [
          {
            "node": "Atendimento",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Set Buffer Mensagem": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Coletar Buffer Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Set Buffer Mensagens",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Buffer Mensagem": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Buffer Mensagens": {
      "main": [
        [
          {
            "node": "Delete Buffer Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Buffer Mensagem": {
      "main": [
        [
          {
            "node": "Tratar número",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Msg ID": {
      "main": [
        [
          {
            "node": "Set Buffer Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Sao_Paulo",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "3aa9218f-fa88-4a42-bf23-320c440fdc25",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "e71ee30208579422913ee1673c6e68fb79d1e7e17d5c1deb0a672e043b70fb7c"
  },
  "id": "iTtlmnCbvGFaNTUv",
  "tags": [
    {
      "updatedAt": "2025-11-18T17:53:57.701Z",
      "createdAt": "2025-11-18T17:53:57.701Z",
      "id": "1B8R571k8L7Grfph",
      "name": "agentic-ai"
    },
    {
      "updatedAt": "2025-11-18T17:53:57.660Z",
      "createdAt": "2025-11-18T17:53:57.660Z",
      "id": "oeBmAL8MEImk87U7",
      "name": "mcp"
    },
    {
      "updatedAt": "2025-11-18T17:53:57.671Z",
      "createdAt": "2025-11-18T17:53:57.671Z",
      "id": "paH52iQOgZunA4KU",
      "name": "test"
    }
  ]
}