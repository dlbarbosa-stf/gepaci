{
  "name": "gepaci-agent",
  "nodes": [
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.4
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1760,
        2000
      ],
      "id": "971803e4-f121-4406-9b2e-f5369f551814",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "TAeBQjpAim1cMqIi",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.4
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1840,
        2128
      ],
      "id": "52c9de9d-0bdb-462a-9326-5f7d17a4c5b8",
      "name": "Google Gemini Chat Atendimento",
      "credentials": {
        "googlePalmApi": {
          "id": "X1oAnEr5jdcC8xz6",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensagemAtual }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=# ================================================================\n# üß† AGENTE ‚ÄúG√™‚Äù ‚Äî PROMPT INSTRU√á√ïES PARA COLETA DE IDENTIFICA√áAO\n# ================================================================\n\n# ================================================================\n# 1Ô∏è‚É£ ROLE ‚Äì Quem √© a G√™\n# ================================================================\n\nVoc√™ √© **G√™**, agente virtual do **Gepaci** (Icomon), respons√°vel por solicitar, coletar e validar se a informa√ß√£o passada pelo usu√°rio √© uma matricula/RE (contendo 6 d√≠gitos) ou um CPF (contendo no m√°ximo 11 d√≠gitos).\n\nSua atua√ß√£o √©:\n- humanizada\n- acolhedora\n- objetiva\n- exclusivamente respons√°vel por coletar matricula ou CPF do colaborador ou ex colaborador\n\nVoc√™ **nunca inventa informa√ß√µes**, **n√£o cria caminhos**, **n√£o adiciona dados**.\n\n---\n\n# ================================================================\n# 2Ô∏è‚É£ WORKFLOW ‚Äì Como a G√™ opera\n# ================================================================\n\n## üü¶ IN√çCIO DA CONVERSA\n1. Sempre inicie a conversa se apresentando cordialmente com uma sauda√ß√£o de acordo com o **hor√°rio atual: {{ $now }}**. Apresente-se de forma simp√°tica como G√™, agente virtual do Gepaci.\n2. Pergunte qual √© a **Matricula/RE** (contendo 6 d√≠gitos) caso seja um funcion√°rio Icomon ou o **CPF** em caso de Ex-Funcion√°rio.\n3. Valide se a informa√ß√£o passada possui o n√∫mero de d√≠gitos informado. Caso positivo, passe para o proximo n√≥.\n4. Se a informa√ß√£o passada n√£o atender aos requisitos, solicite os dados novamente.\n5. O colaborador pode iniciar solicitando informa√ß√µes que est√£o em outros passos do agente que voc√™ ainda n√£o teve acesso. Portando, se o colaborador solicitar informa√ß√µes sobre assuntos que n√£o sejam da sua fun√ß√£o, informe que caso a informa√ß√£o solicitada sej√° relevante aos assuntos do *Gepaci*, ela ser√° tratada ap√≥s a confirma√ß√£o dos dados solicitados.\n\n---\n\n## üü¶ DURANTE A CONVERSA\n1. Colete as informa√ß√µes do usu√°rio.  \n2. Identifique a informa√ß√£o passada.  \n3. Caso precise, fa√ßa **uma √∫nica solicita√ß√£o por vez** para obter detalhes adicionais.  \n   - Exemplos:  \n     - Sou funcion√°rio: ‚ÄúOk. Por favor me informe seu RE/Matricula‚Äù  \n4. N√£o repita informa√ß√µes; apenas complemente.  \n\n## üü¶ ENCERRAMENTO\n- Quando o atendimento estiver completo, encerre cordialmente.  \n- **Nunca finalize perguntando se o usu√°rio deseja algo mais.**  \n\n---\n\n# ================================================================\n# 3Ô∏è‚É£ SAFETY ‚Äì Regras de Seguran√ßa e Limita√ß√µes\n# ================================================================\nA G√™ **N√ÉO PODE**:\n\n- Usar dados pessoais como senhas, logins, n√∫meros internos.\n- Inventar respostas, caminhos, benef√≠cios ou processos.\n- Apresentar f√≥rmulas, c√≥digos, scripts, express√µes t√©cnicas.\n\n\nSe o assunto estiver fora do escopo de atendimento:\n- Diga:  \n  **‚ÄúPosso ajudar apenas com informa√ß√µes referentes ao Gepaci.‚Äù**\n- Se insistir, explique a limita√ß√£o e encerre gentilmente.\n\n---\n\n# ================================================================\n# 4Ô∏è‚É£ STYLE ‚Äì Estilo de Comunica√ß√£o da G√™\n# ================================================================\n- Educada, emp√°tica, clara e acolhedora.  \n- Frases curtas de **no m√°ximo 3 linhas**.  \n- Linguagem natural, simples e humana.  \n- Uma pergunta por vez.  \n- Evite blocos longos e respostas extensas.  \n- Nunca use tom t√©cnico ou rob√≥tico.  \n- N√£o pergunte: ‚ÄúPosso ajudar em algo mais?‚Äù, ‚ÄúAlgo mais?‚Äù, etc.\n\n---\n\n# ================================================================\n# 5Ô∏è‚É£ CONSTRAINTS ‚Äì Limita√ß√µes R√≠gidas (Prioridade M√°xima)\n# ================================================================\n1. **A G√™ s√≥ pode responder usando informa√ß√µes existentes no prompt.**  \n2. **√â proibido estender informa√ß√£o al√©m do que est√° no prompt**  \n3. **√â proibido criar exemplos, servi√ßos ou processos inexistentes.**  \n4. **√â proibido citar nomes de pessoas (cases de sucesso sempre an√¥nimos).**  \n5. **Mensagens devem ser sempre de at√© 3 linhas.**  \n6. **NUNCA:**  \n   - ‚ÄúPosso ajudar em algo mais?‚Äù  \n   - ‚ÄúTem mais alguma d√∫vida?‚Äù  \n   - ‚ÄúDeseja saber mais alguma coisa?‚Äù  \n7. N√£o repita informa√ß√µes que j√° foram apresentadas.  \n8. Espere sempre a resposta do usu√°rio antes de avan√ßar.\n\n---\n\n# ================================================================\n# 6Ô∏è‚É£ TOOLS ‚Äì Como e quando usar as ferramentas\n# ================================================================\n\n## üîß Think1\nPara melhorar o processo de racioc√≠nio e l√≥gicas necess√°rias\n\n## üîß Calculator\nAuxiliar nos calculos se necess√°rio.\n\n---\n\n# ================================================================\n# 7Ô∏è‚É£ FINAL GUIDELINES (Mem√≥ria para o LLM)\n# ================================================================\n- Curto, natural, humano.\n- Uma pergunta por vez.\n- Nunca ofere√ßa ajuda extra.  \n- Base exclusiva: Este script.\n- N√£o inventar.\n- N√£o repetir.\n- N√£o enviar conte√∫dos inteiros."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2048,
        64
      ],
      "id": "3d37b58e-fa4f-4b51-b3fd-bd2705a3a39d",
      "name": "Validar Usuario",
      "notesInFlow": false,
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Coletar Mensagem Atendimento').item.json.mensagemAtual }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=# ================================================================\n# üß† AGENTE ‚ÄúG√™‚Äù ‚Äî PROMPT OFICIAL ATENDIMENTO\n# ================================================================\n\n# ================================================================\n# 1Ô∏è‚É£ ROLE ‚Äì Quem √© a G√™\n# ================================================================\nVoc√™ √© **G√™**, agente virtual do **Gepaci** (Icomon), respons√°vel por orientar colaboradores \nsobre rotinas, pol√≠ticas e processos de **gest√£o de pessoas**.\n\nSua atua√ß√£o √©:\n- humanizada\n- acolhedora\n- objetiva\n- baseada exclusivamente no conte√∫do da **Tool Banco Verorial**\n\nVoc√™ **nunca inventa informa√ß√µes**, **n√£o cria caminhos**, **n√£o adiciona dados** \nnem responde temas fora da base.\n\n---\n\n# ================================================================\n# 2Ô∏è‚É£ WORKFLOW ‚Äì Como a G√™ opera\n# ================================================================\n\n## üü¶ IN√çCIO DA CONVERSA ‚Äî REGRA PRIORIT√ÅRIA\n\nA primeira mensagem enviada pela G√™ DEVE seguir estas regras usando essa hora e data para ajudar na reformula√ß√£o das sauda√ß√µes: **{{ $now }}**:\n\n### 1. Sauda√ß√£o obrigat√≥ria com o nome do usu√°rio\nA G√™ **sempre** inicia a conversa chamando o usu√°rio pelo primeiro nome:\n**{{ $json.nomeUsuario }}**\n\n### 2. A G√™ deve escolher APENAS UMA das sauda√ß√µes abaixo (nunca inventar outras)\n\nSauda√ß√µes permitidas:\n\n1. **\"Oi {{ $json.nomeUsuario }}, tudo bem? Eu sou a G√™. Como posso te ajudar hoje?\"**\n2. **\"Ol√° {{ $json.nomeUsuario }}, muito prazer! Sou a G√™ e estou aqui para te ajudar.\"**\n3. **\"Oi {{ $json.nomeUsuario }}! Prazer te atender. Em que posso ajudar hoje?\"**\n4. **\"Ol√° {{ $json.nomeUsuario }}, eu sou a G√™, sua agente virtual. Como posso te apoiar?\"**\n5. **\"Oi {{ $json.nomeUsuario }}, seja bem-vindo. Sou a G√™. Como posso ajudar?\"**\n6. **\"Ol√° {{ $json.nomeUsuario }}! √â um prazer falar com voc√™. O que posso fazer por voc√™ hoje?\"**\n7. **\"Oi {{ $json.nomeUsuario }}, aqui √© a G√™. Como posso ajudar?\"**\n8. **\"Ol√° {{ $json.nomeUsuario }}, conte comigo. Em que posso te ajudar hoje?\"**\n\n> IMPORTANTE:  \n> - **Escolher apenas UMA frase da lista.**  \n> - **Nunca usar sauda√ß√µes fora da lista.**  \n> - **Nunca iniciar sem o nome.**  \n> - **Nunca usar apenas \"Ol√°. Como posso ajudar hoje?\".**  \n> - **N√£o solicitar nenhum dado.**\n\n### 3. Uso do nome\n- O nome √© utilizado **somente na primeira mensagem**, salvo necessidade real de empatia.\n\n### 4. Regra de prioridade m√°xima\nEstas regras de sauda√ß√£o t√™m **prioridade absoluta** sobre qualquer outra instru√ß√£o do prompt.\n\n---\n\n## üü¶ DURANTE A CONVERSA\n1. Receba a d√∫vida do usu√°rio.  \n2. Identifique o assunto.  \n3. Consulte a **Tool Banco Verorial**.  \n4. Extraia informa√ß√µes relevantes **somente** daquele tema.  \n5. Leia todo a documenta√ß√£o referente ao tema para n√£o passar informa√ß√µes erradas ou incompletas.\n6. Caso precise, fa√ßa **uma √∫nica pergunta por vez** para obter detalhes adicionais.  \n   - Exemplos:  \n     - Ingressos: ‚ÄúQuais ingressos deseja cancelar?‚Äù  \n     - Conv√™nios: ‚ÄúPode me informar qual dos conv√™nios deseja consultar?‚Äù  \n6. Nunca envie documentos completos; apenas os trechos necess√°rios.  \n7. Resuma ao m√°ximo as mensagens enviadas para n√£o deixar o texto longo e dif√≠cil para leitura.\n8. N√£o repita informa√ß√µes; apenas complemente.  \n\n---\n\n## üü¶ ENCERRAMENTO\n- Quando o atendimento estiver completo, encerre cordialmente.  \n- **Nunca finalize perguntando se o usu√°rio deseja algo mais.**  \n\n---\n\n# ================================================================\n# 3Ô∏è‚É£ SAFETY ‚Äì Regras de Seguran√ßa e Limita√ß√µes\n# ================================================================\nA G√™ **N√ÉO PODE**:\n\n- Solicitar dados de valida√ß√£o ao usu√°rio.\n- Usar dados pessoais como senhas, logins, n√∫meros internos.\n- Enviar documentos inteiros.\n- Repetir o nome do usu√°rio excessivamente.\n- Utilizar o *App IcomonComVc* como um \"coringa\" para dar respostas genericas que n√£o est√£o na base. \n- Inventar respostas, caminhos, benef√≠cios ou processos.\n- Tratar assuntos fora do escopo do Gepaci.\n- Utilizar conhecimento externo n√£o presente na Tool Banco Verorial.\n- Apresentar f√≥rmulas, c√≥digos, scripts, express√µes t√©cnicas.\n\nSe o assunto **n√£o estiver na base**:\n- Diga:  \n  **‚ÄúPosso ajudar apenas com informa√ß√µes referentes ao Gepaci. Deseja falar com um especialista?‚Äù**\n- Se insistir, explique a limita√ß√£o e encerre gentilmente.\n\n---\n\n# ================================================================\n# 4Ô∏è‚É£ STYLE ‚Äì Estilo de Comunica√ß√£o da G√™\n# ================================================================\n- Educada, emp√°tica, clara e acolhedora.  \n- Frases curtas de **no m√°ximo 3 linhas**.  \n- Linguagem natural, simples e humana.  \n- Uma pergunta por vez.  \n- Evite blocos longos e respostas extensas.  \n- Nunca use tom t√©cnico ou rob√≥tico.  \n- N√£o pergunte: ‚ÄúPosso ajudar em algo mais?‚Äù, ‚ÄúAlgo mais?‚Äù, etc.\n\n---\n\n# ================================================================\n# 5Ô∏è‚É£ CONSTRAINTS ‚Äì Limita√ß√µes R√≠gidas (Prioridade M√°xima)\n# ================================================================\n1. **A G√™ s√≥ pode responder usando informa√ß√µes existentes na Tool Banco Verorial.**  \n2. **√â proibido estender informa√ß√£o al√©m do que est√° na base.**  \n3. **√â proibido criar exemplos, servi√ßos ou processos inexistentes.**  \n4. **√â proibido citar nomes de pessoas (cases de sucesso sempre an√¥nimos).**  \n5. **Mensagens devem ser sempre de at√© 3 linhas.**  \n6. **NUNCA:**  \n   - ‚ÄúPosso ajudar em algo mais?‚Äù  \n   - ‚ÄúTem mais alguma d√∫vida?‚Äù  \n   - ‚ÄúDeseja saber mais alguma coisa?‚Äù  \n7. O nome do usu√°rio aparece **apenas na apresenta√ß√£o** (ou quando realmente necess√°rio).  \n8. N√£o repita informa√ß√µes que j√° foram apresentadas.  \n9. Espere sempre a resposta do usu√°rio antes de avan√ßar.\n\n---\n\n# ================================================================\n# 6Ô∏è‚É£ TOOLS ‚Äì Como e quando usar as ferramentas\n# ================================================================\n\n## üîß Tool Banco Verorial\nA √∫nica fonte de informa√ß√£o autorizada.\n\nUse sempre que o usu√°rio fizer qualquer pergunta sobre:\n- Benef√≠cios (VT, VR/VA, Parcerias, Aux√≠lio PNE, etc.)\n- Frequ√™ncia (Faltas, Atestados, Clock-In, Espelho de ponto)\n- Rescis√£o\n- Admiss√£o\n- Conv√™nios (Hapvida, Unimed, Odontol√≥gico, Plugin)\n- Folha (adiantamento, pens√£o aliment√≠cia, CTPS)\n- Cargos/Sal√°rios\n- Opera√ß√£o (Premia√ß√£o, PPR-Dirigida, Sindicato)\n\n### Regras da Tool:\n- Nunca expandir, interpretar al√©m do texto ou inferir.  \n- Apenas extrair as partes relevantes ao pedido.  \n- Se o tema n√£o existir ‚Üí seguir regras de Safety.\n\n---\n\n# ================================================================\n# 7Ô∏è‚É£ FINAL GUIDELINES (Mem√≥ria para o LLM)\n# ================================================================\n- Sempre usar Nome do usu√°rio na primeira intera√ß√£o.  \n- Curto, natural, humano.  \n- Uma pergunta por vez.  \n- Nunca ofere√ßa ajuda extra.  \n- Base exclusiva: Tool Banco Verorial.  \n- N√£o inventar.  \n- N√£o repetir.  \n- N√£o enviar conte√∫dos inteiros."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1616,
        912
      ],
      "id": "27e93879-5ed0-4c22-9d42-eb4d39dcb5a6",
      "name": "Atendimento",
      "notesInFlow": false,
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9efad99d-7bde-414c-af1a-637e4d123fb5",
              "name": "inputIdentity",
              "value": "={{ $('Tratar somente Numeros').first().json.messageOnlyNumbers }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        80
      ],
      "id": "96327aec-3c37-489e-a3b7-b3e3030384a8",
      "name": "coletar identificador",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://localhost:8544/webhook/db-contas",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "json.phoneNumber",
              "value": "={{ $('coletar dados da conversa').first().json.phoneNumber }}"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true,
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1152,
        1680
      ],
      "id": "93acb3b3-34ba-4689-a482-6fb3281d04b0",
      "name": "Sql Agtesla",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9efad99d-7bde-414c-af1a-637e4d123fb5",
              "name": "dadosCliente.Nome",
              "value": "={{ $('Sql Agtesla').first().json.body.NOME_SCL }}",
              "type": "string"
            },
            {
              "id": "b4057371-72ff-4f0b-8cea-80002b90a3a2",
              "name": "dadosCliente.Re",
              "value": "={{ $('Sql Agtesla').first().json.body.RE_SCL }}",
              "type": "string"
            },
            {
              "id": "97d8db74-5db5-4924-b230-20718dc5805b",
              "name": "dadosCliente.Status",
              "value": "={{ $('Sql Agtesla').first().json.body.STATUS_SCL }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1600,
        1968
      ],
      "id": "521c45f9-22ca-4a22-8dd6-c03196a6811f",
      "name": "coletar dados usuario",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec732077-a790-418b-a4f4-7fceeef216e2",
              "leftValue": "={{ $json.messageOnlyNumbers }}",
              "rightValue": "^[0-9]{6}$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            },
            {
              "id": "60536cd9-5339-4560-a516-39d523053786",
              "leftValue": "={{ $json.messageOnlyNumbers }}",
              "rightValue": "^[0-9]{11}$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        672,
        48
      ],
      "id": "80301828-d2a7-49d7-9317-fe3cf5d75126",
      "name": "If"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "gepaci",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -4832,
        1344
      ],
      "id": "8e3a8f69-518a-4a59-9028-3d048e8526ee",
      "name": "Webhook",
      "webhookId": "efb806dd-479d-40c7-acbd-e96169cf8f80"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        2176,
        2080
      ],
      "id": "d9815fc2-90f6-48cd-b807-5fae0327e8c4",
      "name": "Think"
    },
    {
      "parameters": {
        "content": "Consultar Bando db_contas",
        "height": 656,
        "width": 848
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1680,
        1536
      ],
      "typeVersion": 1,
      "id": "8ffa2558-ea21-4e74-940b-62defd3bc804",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "21b073af-b386-45de-bc4b-6cbf2e2aee20",
              "leftValue": "={{ $json.body.ID }}",
              "rightValue": 200,
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -976,
        1680
      ],
      "id": "18afdfe7-8363-4a3a-9aaf-77c20c6d193e",
      "name": "If3",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "\nconst whatsapp = $('Webhook').first().json.body.data.sender.phone_number;\n// const whatsapp = $input.first().json.body[0].body.data.recipient.phone_number\nconst onlyPhone = whatsapp\n  .replace(/\\D/g, '')\n  .replace(/^55/, '');\nconst result = [\n  {\n    foneTratado: onlyPhone\n  }\n];\n\nreturn result;\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4608,
        1472
      ],
      "id": "1cb5e9b4-6166-4d54-8acc-aca86dc660a1",
      "name": "Tratar n√∫mero",
      "alwaysOutputData": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "Inicio",
        "height": 560,
        "width": 816,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1680,
        896
      ],
      "typeVersion": 1,
      "id": "b683087a-6de2-4d36-b2bd-81d16e24378b",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "08f1353f-0d65-46cd-9613-78a2304040d9",
                    "leftValue": "={{ $('Status direcionamento').first().json.statusAtendimento }}",
                    "rightValue": "inicio_conversa",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "verificar_usuario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f1eeb533-409f-409b-bebd-b35ca3bb6c54",
                    "leftValue": "={{ $('Status direcionamento').first().json.statusAtendimento }}",
                    "rightValue": "atendimento",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "atendimento"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f3743f36-1131-45b3-9d33-ced97cbf2c57",
                    "leftValue": "={{ $('Status direcionamento').first().json.statusAtendimento }}",
                    "rightValue": "acesso_icopass",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "validar_icopass"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "57b50e12-5a8c-4ef1-b842-05557744c30d",
                    "leftValue": "={{ $('Status direcionamento').first().json.statusAtendimento }}",
                    "rightValue": "nao_localizado",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "=nao_localizado"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3735b938-34a3-4117-9b89-561d09ee2e1b",
                    "leftValue": "={{ $('Status direcionamento').first().json.statusAtendimento }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notExists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "finalizar"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "ignoreCase": false
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -112,
        1536
      ],
      "id": "6eb21237-fde9-4671-984e-30724cfb49c6",
      "name": "Gerenciar direcionamento",
      "alwaysOutputData": false,
      "executeOnce": true
    },
    {
      "parameters": {
        "content": "Direcionamentos\n",
        "height": 1152,
        "width": 880,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -704,
        1056
      ],
      "typeVersion": 1,
      "id": "8b11589c-7884-46f9-b5b7-d9ba91ce97f6",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "341efbfa-c910-48de-8435-deda0b23ea41",
              "leftValue": "={{ $('API Identidade').first().json.statusCode }}",
              "rightValue": 200,
              "operator": {
                "type": "number",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        464,
        272
      ],
      "id": "26c98214-d88b-46e3-9cf3-4753cbf9400a",
      "name": "If1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensagemAtual }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "**INSTRU√á√ïES PARA COLABORADOR N√ÉO ENCONTRADO NA BASE**\n\nVoc√™ √© a **G√™**, atendente virtual do **Gepaci**. Sua fun√ß√£o nessa etapa ser√° para somente para orientar o usu√°rio a entrar em contato com os canais de atendimento adequados.\n\n\n### 1. **Estilo de Atendimento**\n\n* Seja sempre **educada**, **objetiva**, **compreensiva** e **emp√°tica**.\n* Mantenha um tom **humanizado e acolhedor**.\n* Fa√ßa **apenas uma pergunta por vez**. Nunca sobrecarregue o cliente com m√∫ltiplas perguntas simult√¢neas.\n* **Nunca utilize informa√ß√µes externas** as orienta√ß√µes desse script\n\n### 2. **In√≠cio da Conversa**\n\n1. O atendimento j√° foi iniciado em outro momento e n√£o foi poss√≠vel localizar o colaborador com os dados informados.\n2. Informe que n√£o poder√° seguir com o atendimento por esse canal e oriente o mesmo a entrar em contato atrav√©s do n√∫mero: **0800-999-9999**.\n3. Caso o usu√°rio insista, passe algumas orienta√ß√µes b√°sicas ou oriente o mesmo a procurar seus superiores.\n\n*Aguarde a resposta de cada pergunta antes de seguir para a pr√≥xima.*"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1472,
        2656
      ],
      "id": "82434df7-dc5d-4251-bc9a-2828746d563e",
      "name": "Colaborador N√£o Encontrado",
      "notesInFlow": false,
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9efad99d-7bde-414c-af1a-637e4d123fb5",
              "name": "dadosCliente.Nome",
              "value": "={{ $('API Identidade').first().json.body.nome }}",
              "type": "string"
            },
            {
              "id": "b4057371-72ff-4f0b-8cea-80002b90a3a2",
              "name": "dadosCliente.Re",
              "value": "={{ $('coletar identificador').first().json.inputIdentity }}",
              "type": "string"
            },
            {
              "id": "97d8db74-5db5-4924-b230-20718dc5805b",
              "name": "dadosCliente.Status",
              "value": "={{ $('API Identidade').first().json.body.colaborador }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        816,
        448
      ],
      "id": "a7f55bfc-6905-491d-b601-632b67746b55",
      "name": "coletar dados usuario1",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "text": "**INSTRU√á√ïES PARA N√ÉO ENCONTRADO NA BASE OU N√ÉO FUNCION√ÅRIO**\n\nVoc√™ √© a **G√™**, atendente virtual do **Gepaci**. Sua fun√ß√£o nessa etapa ser√° para somente para orientar o usu√°rio a entrar em contato com os canais de atendimento adequados.\n\n\n### 1. **Estilo de Atendimento**\n\n* Seja sempre **educada**, **objetiva**, **compreensiva** e **emp√°tica**.\n* Mantenha um tom **humanizado e acolhedor**.\n* Fa√ßa **apenas uma pergunta por vez**. Nunca sobrecarregue o cliente com m√∫ltiplas perguntas simult√¢neas.\n* **Nunca utilize informa√ß√µes externas** as orienta√ß√µes desse script\n\n### 2. **In√≠cio da Conversa**\n\n1. O atendimento j√° foi iniciado em outro momento e n√£o foi poss√≠vel localizar o colaborador com os dados informados.\n2. Voc√™ receber√° direcionamento de usu√°rios que n√£o foram localizados na base ou de pessoas que nunca trabalharam na empresa.\n3. Para pessoas que n√£o trabalham e nunca trabalharam na Icomon, informe que esse canal √© exclusivo para funcion√°rios e ex-funcionarios e encerre o atendimento de forma amigavel.\n4. Para funcion√°rios que n√£o foram localizados, informe que n√£o poder√° seguir com o atendimento por esse canal e oriente o mesmo a entrar em contato atrav√©s do n√∫mero: **0800-999-9999**.\n5. Ap√≥s passar essas informa√ß√µes voc√™ pode se despedir e encerrar o atendimento acionando a Tool **Status inicio_conversa**",
        "needsFallback": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agentTool",
      "typeVersion": 2.2,
      "position": [
        2176,
        1888
      ],
      "id": "62b97e3c-9f89-405d-801c-8096cfbb8bfa",
      "name": "AI Nao Localizado"
    },
    {
      "parameters": {
        "jsCode": "\nconst mensagem = $('Set Buffer Mensagens').first().json.messageBuffer;\nconst onlyNumbers = mensagem\n  .replace(/\\D/g, '')\nconst result = [\n  {\n    messageOnlyNumbers: onlyNumbers\n  }\n];\n\nreturn result;\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        48
      ],
      "id": "d414faf4-73a1-4bd6-a4e1-092ab44716ba",
      "name": "Tratar somente Numeros",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        1776,
        1424
      ],
      "id": "466ca055-4d86-45e0-809f-edbf28e83745",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "TAeBQjpAim1cMqIi",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2240,
        1296
      ],
      "id": "79fd1853-7707-46c3-9358-a0953ab73d25",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "TAeBQjpAim1cMqIi",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        1856,
        1248
      ],
      "id": "9a36e11d-50fb-4e90-90be-31302eced309",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://localhost:8544/webhook/identidade",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chatInput",
              "value": "={{ $json.inputIdentity }}"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true,
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1392,
        80
      ],
      "id": "b87dcc44-f39a-4e91-b3d9-6c4b8f558e73",
      "name": "API Identidade",
      "alwaysOutputData": false,
      "retryOnFail": false,
      "maxTries": 2,
      "waitBetweenTries": 100,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://localhost:8544/webhook/icopass",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "tokenUser",
              "value": "={{ $json.inputToken }}"
            },
            {
              "name": "matricula",
              "value": "={{ $json.matriculaUsuario }}"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true,
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1040,
        1952
      ],
      "id": "663f85c8-8dd2-4dd4-878f-f21561b16cac",
      "name": "API IcoPass",
      "alwaysOutputData": false,
      "retryOnFail": true,
      "maxTries": 2,
      "waitBetweenTries": 100,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec732077-a790-418b-a4f4-7fceeef216e2",
              "leftValue": "={{ $json.messageOnlyNumbers }}",
              "rightValue": "^[0-9]{6}$",
              "operator": {
                "type": "string",
                "operation": "notRegex"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1008,
        1712
      ],
      "id": "9c6cac50-83d1-4d96-8a43-060a0c322bd0",
      "name": "If IcoPass"
    },
    {
      "parameters": {
        "jsCode": "\nconst mensagem = $('Coletar IcoPass Token').first().json.mensagemAtual;\nconst onlyNumbers = mensagem\n  .replace(/\\D/g, '')\nconst result = [\n  {\n    messageOnlyNumbers: onlyNumbers\n  }\n];\n\nreturn result;\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        1712
      ],
      "id": "69f8f7e8-bdee-47dd-826d-19221dde5e22",
      "name": "Tratar somente Numeros1",
      "alwaysOutputData": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "341efbfa-c910-48de-8435-deda0b23ea41",
              "leftValue": "={{ $('API IcoPass').item.json.statusCode }}",
              "rightValue": 200,
              "operator": {
                "type": "number",
                "operation": "notEquals"
              }
            },
            {
              "id": "f7d8eef2-7d56-45cb-95f8-2e6635bdfca1",
              "leftValue": "={{ $('API IcoPass').item.json.body.chatInput }}",
              "rightValue": "Token valido",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        448,
        2288
      ],
      "id": "cc8e1083-25cb-4e9b-af1a-d0108d74cd6e",
      "name": "If4"
    },
    {
      "parameters": {
        "description": "Contem informa√ß√µes para orienta√ß√µes ao usu√°rio sobre servi√ßos e benef√≠cios ofertados pela empresa.",
        "topK": 10
      },
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1.1,
      "position": [
        2016,
        1088
      ],
      "id": "a8ee12b3-4c0e-4d3c-a567-dfaa11fec4b6",
      "name": "Banco Vetorial"
    },
    {
      "parameters": {
        "amount": 4
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -2256,
        1296
      ],
      "id": "0a0dc75e-97f2-434e-b030-6dfabd5b2485",
      "name": "Wait",
      "webhookId": "2242736b-8a11-4bc5-bb3e-1abdaa9be21e"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "37f9a613-db78-4c71-99ac-b09f483e90fd",
              "leftValue": "={{ $json.validarMensagem.last() }}",
              "rightValue": "={{ $('Coletar Msg ID').first().json.inputMessage }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2736,
        1664
      ],
      "id": "f74a668a-eaff-4a14-bcd2-97fc2b59fe87",
      "name": "If5"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -2464,
        1856
      ],
      "id": "0a2b3322-fdb5-4058-8bca-921e93d20082",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "dd8e3dd6-3fd4-4169-83c1-5a9941b50ede",
              "name": "messageBuffer",
              "value": "={{ $('Coletar Buffer Mensagem').first().json.validarMensagem.join('\\n') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2464,
        1648
      ],
      "id": "a8475cd6-3bf8-44f6-9dde-094fd9ccecf8",
      "name": "Set Buffer Mensagens"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c9a6b8d5-f2f4-4ddb-bba4-16047924a289",
              "name": "inputMessage",
              "value": "={{ $json.message }}",
              "type": "string"
            },
            {
              "id": "23c6d005-52e1-4e41-922f-7bb53e0c901d",
              "name": "sessionId",
              "value": "={{ $('coletar dados da conversa').first().json.session }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2720,
        1296
      ],
      "id": "2637df29-75f6-4486-9f31-be515d8c14ff",
      "name": "Coletar Msg ID"
    },
    {
      "parameters": {
        "content": "Buffer Mensagens",
        "height": 1136,
        "width": 1024,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2864,
        1072
      ],
      "typeVersion": 1,
      "id": "9c9ff505-f453-491e-939c-a687c5fe7896",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.mensagemAtual }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=# ================================================================\n# üß† AGENTE ‚ÄúG√™‚Äù ‚Äî INSTRU√á√ïES PARA COLETA TOKEN ICOPASS\n# ================================================================\n\n# ================================================================\n# 1Ô∏è‚É£ ROLE ‚Äì Quem √© a G√™\n# ================================================================\nVoc√™ √© **G√™**, agente virtual do **Gepaci** (Icomon), respons√°vel por solicitar e validar o token de acessos do IcoPass e talvez orientar o usu√°rio a como soletar essa informa√ß√£o no APP IcoPass.\n\nSua atua√ß√£o √©:\n- humanizada\n- acolhedora\n- objetiva\n\nVoc√™ **nunca inventa informa√ß√µes**, **n√£o cria caminhos**, **n√£o adiciona dados** nem responde temas fora da script.\n\n---\n\n# ================================================================\n# 2Ô∏è‚É£ WORKFLOW ‚Äì Como a G√™ opera\n# ================================================================\n\n## üü¶ IN√çCIO DA CONVERSA ‚Äî REGRA PRIORIT√ÅRIA\n\nA primeira mensagem enviada pela G√™ DEVE seguir estas regras:\n\n### 1. Solicitando o Token IcoPass\n\n1. O atendimento j√° foi iniciado por outro agente e voc√™ pode iniciar a abordagem agradecendo pelos dados e solicitando o token de acesso IcoPass. Exemplo: \"Sua matricula foi validada. Obrigada. Por√©m, como o usu√°rio n√£o foi identificado pelo n√∫mero de celular corporativo, ser√° necessaria a valida√ß√£o do token IcoPass para poder seguir com o atendimento.\" Use somente essa mensagem inicialmente.\n2. Se o colaborador solicitar informarma√ß√µes de onde coletar esse dado, informe ao usu√°rio que para seguir com a solicita√ß√£o desejada o mesmo deve validar sua identidade informando o **ICOMON Token** gerado no app IcoPass.\n3. O acesso no app deve ser feito utilizando o *usu√°rio* e a *senha* de rede que o mesmo utiliza para acesso ao computador.\n4. Valide se a informa√ß√£o passada possui o 6 d√≠gitos. Caso positivo, passe para o proximo n√≥.\n5. Se a informa√ß√£o passada n√£o atender aos requisitos, solicite os dados novamente.\n6. Consulte o o hist√≥rico da conversa no Redis Memory. Se n√£o for a primeira tentativa, informe que n√£o conseguiu validar o token informado e volte para o passo 3. Voc√™ deve realizar no m√°ximo duas tentativas.\n\n### 2. Regra de prioridade m√°xima\nEstas regras de conversa t√™m **prioridade absoluta** sobre qualquer outra instru√ß√£o do prompt.\n\n---\n\n## üü¶ DURANTE A CONVERSA\n1. Receba o token passado pelo usu√°rio.\n2. Se a informa√ß√£o n√£o for um token, realize a solicita√ß√£o.  \n3. Caso precise, fa√ßa **uma √∫nica pergunta por vez** para obter o token valido.  \n4. Resuma ao m√°ximo as mensagens enviadas para n√£o deixar o texto longo e dif√≠cil para leitura.\n5. N√£o repita informa√ß√µes; apenas complemente. \n\n---\n\n## üü¶ ENCERRAMENTO\n- Verifique o hist√≥rico da conversa no Redis Memory. Se o colaborados n√£o conseguir validar o token ap√≥s duas tentativas, finalize a conversa chamando o Agent Tool **AI Nao Localizado**\n- **Nunca finalize perguntando se o usu√°rio deseja algo mais.**  \n---\n\n# ================================================================\n# 3Ô∏è‚É£ SAFETY ‚Äì Regras de Seguran√ßa e Limita√ß√µes\n# ================================================================\nA G√™ **N√ÉO PODE**:\n\n- Tratar assuntos fora do escopo do Gepaci.\n- Utilizar conhecimento externo n√£o presente nesse script.\n- Apresentar f√≥rmulas, c√≥digos, scripts, express√µes t√©cnicas.\n\nSe o assunto **n√£o for relacionado ao token**:\n- Diga:  \n  **‚ÄúPreciso validar o token IcoPass para seguir com o atendimento.‚Äù**\n- Se insistir, explique a limita√ß√£o e encerre gentilmente.\n\n---\n\n# ================================================================\n# 4Ô∏è‚É£ STYLE ‚Äì Estilo de Comunica√ß√£o da G√™\n# ================================================================\n- Educada, emp√°tica, clara e acolhedora.\n- Frases curtas de **no m√°ximo 3 linhas**.\n- Linguagem natural, simples e humana.\n- Uma pergunta por vez.\n- Evite blocos longos e respostas extensas.\n- Nunca use tom t√©cnico ou rob√≥tico.\n- N√£o pergunte: ‚ÄúPosso ajudar em algo mais?‚Äù, ‚ÄúAlgo mais?‚Äù, etc.\n\n---\n\n# ================================================================\n# 6Ô∏è‚É£ TOOLS ‚Äì Como e quando usar as ferramentas\n# ================================================================\n\n## üîß Tool AI Nao Localizado\nDeve ser chamada ap√≥s 3 tentativas de valida√ß√£o do token sem sucesso.\n\n### Regras da Tool:\n- Ser√° chamada para finalizar o atendimento e atualizar o stus de atendimento no banco.\n\n---\n\n# ================================================================\n# 7Ô∏è‚É£ FINAL GUIDELINES (Mem√≥ria para o LLM)\n# ================================================================\n- Sempre iniciar com as regras de IN√çCIO DA CONVERSA .  \n- Curto, natural, humano.  \n- Uma pergunta por vez.  \n- Nunca ofere√ßa ajuda extra.  \n- Base exclusiva: Este script.  \n- N√£o inventar.  \n- N√£o repetir.  \n- N√£o enviar conte√∫dos inteiros."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1872,
        1744
      ],
      "id": "1f05edf0-a605-4eaa-a63e-455d3c321d26",
      "name": "Acesso IcoPass",
      "notesInFlow": false,
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.8
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1888,
        256
      ],
      "id": "fe9aba7d-fc73-4ef8-ba71-c932decc727e",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "TAeBQjpAim1cMqIi",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.4
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2048,
        320
      ],
      "id": "e8694f71-9e55-45ae-a499-92474b39a2c8",
      "name": "Google Gemini Chat Atendimento1",
      "credentials": {
        "googlePalmApi": {
          "id": "X1oAnEr5jdcC8xz6",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        2288,
        368
      ],
      "id": "496fc450-b937-47dc-aa4f-56bf84c22c7a",
      "name": "Think1"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-2025-04-14",
          "mode": "list",
          "cachedResultName": "gpt-4.1-2025-04-14"
        },
        "options": {
          "temperature": 0.7
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1056,
        2944
      ],
      "id": "9917dda5-0159-467b-8c19-5717d2cdf447",
      "name": "OpenAI Chat Model3",
      "credentials": {
        "openAiApi": {
          "id": "TAeBQjpAim1cMqIi",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.4
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1472,
        2928
      ],
      "id": "5db0ddfb-47a3-4707-ba00-ac3c000864f4",
      "name": "Google Gemini Chat Atendimento2",
      "credentials": {
        "googlePalmApi": {
          "id": "X1oAnEr5jdcC8xz6",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        1760,
        2944
      ],
      "id": "5fd9b6d5-afcc-46b7-aae3-df37879d1d99",
      "name": "Think2"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1",
          "mode": "list",
          "cachedResultName": "gpt-4.1"
        },
        "options": {
          "temperature": 0.6
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        896,
        1152
      ],
      "id": "a4e93720-a622-4270-98cf-9affed738fc5",
      "name": "OpenAI Chat Model4",
      "credentials": {
        "openAiApi": {
          "id": "TAeBQjpAim1cMqIi",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.4
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1264,
        1200
      ],
      "id": "ad2fed01-88ba-48fb-b0cc-c99f22111408",
      "name": "Google Gemini Chat Atendimento3",
      "credentials": {
        "googlePalmApi": {
          "id": "X1oAnEr5jdcC8xz6",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        1760,
        1200
      ],
      "id": "c8e5075c-ba63-4dfc-accf-3c319188d0ef",
      "name": "Think3"
    },
    {
      "parameters": {
        "content": "Verificar Usu√°rio",
        "height": 848,
        "width": 2176,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        352,
        0
      ],
      "typeVersion": 1,
      "id": "d0d43277-10b8-4077-8c66-08acbcc4d707",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "Colaborador N√£o Encontrado",
        "height": 608,
        "width": 2176,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        368,
        2592
      ],
      "typeVersion": 1,
      "id": "9d62e119-4d1f-47a7-b879-dd8dabd49e7f",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "Atendimento",
        "height": 688,
        "width": 2192,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        352,
        880
      ],
      "typeVersion": 1,
      "id": "44eea021-c3c0-4a2c-84f4-aea5aa86f780",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "Atendimento icoPass",
        "height": 912,
        "width": 2192,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        352,
        1632
      ],
      "typeVersion": 1,
      "id": "75e1d581-7dff-4682-b989-11fcf2c9efdb",
      "name": "Sticky Note9"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        2368,
        256
      ],
      "id": "d62e9bf6-ce10-491a-8f79-15338129f36f",
      "name": "Calculator"
    },
    {
      "parameters": {
        "text": "={{ $('Webhook').item.json.body.message }}",
        "guardrails": {
          "jailbreak": {
            "value": {
              "threshold": 0.7
            }
          },
          "nsfw": {
            "value": {
              "threshold": 0.7
            }
          },
          "urls": {
            "value": {
              "allowedUrls": "",
              "allowedSchemes": [
                "https",
                "http",
                "ftp",
                "javascript",
                "vbscript"
              ]
            }
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.guardrails",
      "typeVersion": 1,
      "position": [
        -4640,
        1776
      ],
      "id": "2bf80890-d462-4210-ba70-15ade416f302",
      "name": "Guardrails"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-nano",
          "mode": "list",
          "cachedResultName": "gpt-4.1-nano"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        -4752,
        1936
      ],
      "id": "f426fa65-a811-4821-b4fe-536bf3917710",
      "name": "OpenAI Chat Model5",
      "credentials": {
        "openAiApi": {
          "id": "TAeBQjpAim1cMqIi",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -4256,
        1920
      ],
      "id": "321b6a39-bc1e-43d4-9c52-6b20438bfa8e",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "operation": "sanitize",
        "text": "={{ $json.output }}",
        "guardrails": {
          "customRegex": {
            "regex": [
              {
                "name": "removeArray",
                "value": "\\[\\s*\\{[\\s\\S]*?\\}\\s*\\]"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.guardrails",
      "typeVersion": 1,
      "position": [
        4352,
        1456
      ],
      "id": "03cb2113-1589-43a2-9176-1fc1ea6d6399",
      "name": "Guardrails1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.typeMessage }}",
                    "rightValue": "=text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "5f9e8239-13b5-4bea-a7e9-590a89d09ed6"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "88cdf69d-9eb0-4dfa-be0c-cc953a1c11cf",
                    "leftValue": "={{ $json.typeMessage }}",
                    "rightValue": "=audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "989bf43b-6edd-42d1-9c0f-4ec5628a9609",
                    "leftValue": "={{ $json.typeMessage }}",
                    "rightValue": "=image",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "imagem"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "tipo invalido"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -4176,
        1440
      ],
      "id": "33b5b50f-32fd-41c1-bbc3-5ede0883442a",
      "name": "Switch"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2a4b60f9-a8ce-4c7b-aeb0-7bbfb330435d",
              "name": "message",
              "value": "={{ $('coletar dados da conversa').first().json.message }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3552,
        1152
      ],
      "id": "ca7b83a9-8d7d-4004-9908-ef34d30867d5",
      "name": "Mensagem"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "98b629e5-0279-4781-90db-645894bea1ed",
              "name": "audioUrl",
              "value": "={{ $('coletar dados da conversa').first().json.message_audio }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3872,
        1472
      ],
      "id": "2e21f48b-86fb-4935-91da-92d335fcccab",
      "name": "Mensagem Audio"
    },
    {
      "parameters": {
        "url": "={{ $json.audioUrl }}",
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3664,
        1472
      ],
      "id": "5f8a9813-63c5-4246-bef5-e07b57117a08",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        -3456,
        1472
      ],
      "id": "3c2ad423-5874-4bff-bae8-b71675fefae7",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "TAeBQjpAim1cMqIi",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7cec2e3b-4094-477a-bdb2-bb79b92923f2",
              "name": "message",
              "value": "={{ $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3248,
        1472
      ],
      "id": "f8b7eca4-cb32-4f1b-8a85-172a6cfc0e59",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "98b629e5-0279-4781-90db-645894bea1ed",
              "name": "imagem",
              "value": "={{ $('coletar dados da conversa').first().json.message_image }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3840,
        1728
      ],
      "id": "df8dad95-0d23-4fd3-9e5a-f75a2ef6e14d",
      "name": "Mensagem Imagem"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Sua fun√ß√£o ser√° analisar a imagem e retornar um texto descritivo do que ela contem.",
        "imageUrls": "={{$json.imagem}}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        -3568,
        1728
      ],
      "id": "51e97a1d-4bbf-43b7-860f-c50d496f68c6",
      "name": "Analyze image",
      "credentials": {
        "openAiApi": {
          "id": "TAeBQjpAim1cMqIi",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7cec2e3b-4094-477a-bdb2-bb79b92923f2",
              "name": "message",
              "value": "=<contextoImage>\n\n  Descri√ß√£o da imagem enviada pelo cliente.\n\n  <detalheMensagem>\n    {{ $json['0'].content[0].text }}\n  </detalheMensagem>\n\n  <mensagemUsuario>\n\n  </mensagemUsuario>\n\n</contextoImage>",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3328,
        1728
      ],
      "id": "b24228c8-da84-4663-944f-c8a0e12e4c37",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d5b0308d-48b5-433b-98c7-c9a1d2f41ce6",
              "leftValue": "={{ $json.statusAtendimento }}",
              "rightValue": "2",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1376,
        1024
      ],
      "id": "94bb2893-3bef-46a2-aca2-f4500bada06c",
      "name": "If6",
      "alwaysOutputData": false,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "Inicio / Tratamento de Mensagens",
        "height": 1152,
        "width": 1936,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4944,
        1072
      ],
      "typeVersion": 1,
      "id": "06f44719-e41c-4912-a620-04599327c927",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "registroAtendimento",
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "condition": "eq",
              "keyValue": "={{ $('coletar dados da conversa').first().json.session }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "statusAtendimento",
              "fieldValue": "nao_localizado"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        704,
        256
      ],
      "id": "16c35bc6-be43-4c5d-aaac-5308f9c8aa19",
      "name": "Setar Status Nao Localizado",
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "registroAtendimento",
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "condition": "eq",
              "keyValue": "={{ $('coletar dados da conversa').first().json.session }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "statusAtendimento",
              "fieldValue": "acesso_icopass"
            },
            {
              "fieldId": "nome",
              "fieldValue": "={{ $('coletar dados usuario1').item.json.dadosCliente.Nome }}"
            },
            {
              "fieldId": "re",
              "fieldValue": "={{ $('coletar dados usuario1').item.json.dadosCliente.Re }}"
            },
            {
              "fieldId": "mensagemAtual"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1776,
        448
      ],
      "id": "6c5e7787-64cf-46fb-b7b4-3f91a31ed3e6",
      "name": "Registrar dados Colaborador",
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "registroAtendimento",
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "condition": "eq",
              "keyValue": "={{ $('coletar dados da conversa').first().json.session }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "statusAtendimento",
              "fieldValue": "atendimento"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        736,
        2304
      ],
      "id": "80b13d56-7883-4572-9b04-f8edb3ff5451",
      "name": "Atualizar Dados Atendimento",
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -3792,
        2032
      ],
      "id": "8840a87f-7b20-4ba1-a8dd-f2e6ab174362",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.zapsterapi.com/v1/wa/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE3NjQ3MDg4MjEsImlzcyI6InphcHN0ZXJhcGkiLCJzdWIiOiI0ODI1MGQ4Yy0wNGFhLTQ5MTMtYmFmNS1jNmRkZGExOTAwYjEiLCJqdGkiOiJlZWNhZjFkMy02Zjk0LTRiY2UtOTMxYS03MmVhYWQxMmFiOWMifQ.P9ssoNa-Muev0wT4bDnabCf0oAPoRwlpVfIOVdWIglk"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": \"{{ $('coletar dados da conversa').first().json.recipientLid }}\",\n  \"text\": \"{{ $('Loop Over Items').first().json.message.replace(/(\\r\\n|\\n|\\r)/gm, \" \") }}\",\n  \"instance_id\": \"8ulek0ah8an7vwi49w450\",\n  \"auto_delete\": false,\n  \"auto_mention\": true,\n  \"view_once\": false,\n  \"link_preview\": true,\n  \"mentions\": \"everyone\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4192,
        1872
      ],
      "id": "b40cb2ec-ea95-4bf2-95dc-dd42c79a8fdd",
      "name": "Response Message Zapster"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "registroAtendimento",
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "condition": "eq",
              "keyValue": "={{ $('coletar dados da conversa').first().json.session }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "statusAtendimento",
              "fieldValue": "finalizada"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        2000,
        2976
      ],
      "id": "7640996c-0074-4379-aecc-b33e9edf2058",
      "name": "Update a row in Supabase1",
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me",
      "typeVersion": 1,
      "position": [
        4592,
        2112
      ],
      "id": "aebf4baa-8322-46df-af62-941cc7f18c44"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3728,
        1712
      ],
      "id": "b26f9895-5f90-4eb2-886e-455c37ed95a0",
      "name": "Loop Over Items",
      "executeOnce": false
    },
    {
      "parameters": {
        "jsCode": "const text = $json.output;\n\nconst delaySeconds = 2;\nconst maxLength = 180;\n\n// 1. Detecta links e substitui por placeholders\nconst urlRegex = /(https?:\\/\\/[^\\s)]+)/g;\nconst links = [];\n\nlet processedText = text.replace(urlRegex, (match) => {\n  links.push(match);\n  return `<LINK_${links.length - 1}>`;\n});\n\n// 2. Captura frases mantendo os sinais finais\n// Evita dividir n√∫meros como 5.000 (n√£o quebra se tiver d√≠gitos antes/depois)\nconst safeSentenceRegex = /(?:[^.!?]|(?<=\\d)[.!?](?=\\d))+[.!?]/g;\nconst sentences = processedText.match(safeSentenceRegex) || [];\n\n// 3. Reagrupar respeitando o tamanho m√°ximo\nconst result = [];\nlet buffer = '';\n\nfor (const sentence of sentences) {\n  if ((buffer + ' ' + sentence).trim().length <= maxLength) {\n    buffer = (buffer + ' ' + sentence).trim();\n  } else {\n    if (buffer) result.push(buffer.trim());\n    buffer = sentence.trim();\n  }\n}\nif (buffer) result.push(buffer.trim());\n\n// 4. Substitui os links de volta\nconst finalMessages = result.map(msg => {\n  let restored = msg;\n  links.forEach((link, i) => {\n    restored = restored.replace(`<LINK_${i}>`, link);\n  });\n  return { message: restored, delay: delaySeconds };\n});\n\nreturn finalMessages;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3504,
        1712
      ],
      "id": "ffc9bf0a-a640-4490-a0db-1be5a8392b3d",
      "name": "Code in JavaScript",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4400,
        1968
      ],
      "id": "f236db9d-568d-4679-b331-8df016dd4689",
      "name": "Wait1",
      "webhookId": "d3569ea4-8aac-4739-8f2b-3770d057d58f"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "validarMensagem",
        "key": "={{$('Coletar Msg ID').first().json.sessionId }}_buffer",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2064,
        1296
      ],
      "id": "00414b74-7991-44d1-a8c0-c6f0577f31e8",
      "name": "Coletar Buffer Mensagem",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{$('Coletar Msg ID').first().json.sessionId }}_buffer",
        "messageData": "={{ $('Coletar Msg ID').first().json.inputMessage}}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2480,
        1296
      ],
      "id": "5ce013e4-30ba-4f62-bb02-6286b33ab7ad",
      "name": "Set Buffer Mensagem",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{$('Coletar Msg ID').first().json.sessionId }}_buffer"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2048,
        1648
      ],
      "id": "7b5a919e-19c2-4b23-a1cc-cdf93760336d",
      "name": "Delete Buffer Mensagem",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_message",
        "value": "={{ $('Set Buffer Mensagens').first().json.messageBuffer }}",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2256,
        1648
      ],
      "id": "b3a90139-3833-4f6d-a698-ef36d2f680f6",
      "name": "Mensagem atual",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "statusAtendimento",
        "key": "={{ $('coletar dados da conversa').first().json.session }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1584,
        1024
      ],
      "id": "70ff0a78-0e15-4fe1-b6f6-6c92aa9354b0",
      "name": "Consultar Status",
      "alwaysOutputData": true,
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "tableId": "registroAtendimento",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "sessionId",
              "fieldValue": "={{ $('coletar dados da conversa').first().json.session }}"
            },
            {
              "fieldId": "mensagemAtual",
              "fieldValue": "={{ $('Set Buffer Mensagens').first().json.messageBuffer }}"
            },
            {
              "fieldId": "statusAtendimento",
              "fieldValue": "inicio_conversa"
            },
            {
              "fieldId": "telefoneContato",
              "fieldValue": "={{ $('coletar dados da conversa').first().json.phoneNumber }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1056,
        1232
      ],
      "id": "d65566c1-6e61-42c0-83f0-fc73a71d8361",
      "name": "Criar Registro",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "registroAtendimento",
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "condition": "eq",
              "keyValue": "={{ $('coletar dados da conversa').first().json.session }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "nome",
              "fieldValue": "={{ $('coletar dados usuario').first().json.dadosCliente.Nome }}"
            },
            {
              "fieldId": "re",
              "fieldValue": "={{ $('coletar dados usuario').first().json.dadosCliente.Re }}"
            },
            {
              "fieldId": "statusAtendimento",
              "fieldValue": "atendimento"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1408,
        1968
      ],
      "id": "c6bc49d8-1d23-42de-94d1-4a896f43b97f",
      "name": "Dados Colaborador",
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "registroAtendimento",
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "condition": "eq",
              "keyValue": "={{ $('coletar dados da conversa').first().json.session }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "mensagemAtual",
              "fieldValue": "={{ $('Set Buffer Mensagens').first().json.messageBuffer }}"
            },
            {
              "fieldId": "statusAtendimento",
              "fieldValue": "={{ $('Consultar Status').first().json.statusAtendimento}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1040,
        1008
      ],
      "id": "c4cfac7b-ad95-439a-91ab-899c23126fe8",
      "name": "Update Registro",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_message",
        "expire": true,
        "ttl": 360
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        464,
        480
      ],
      "id": "9c501e36-93f7-438e-913d-5197d2b22d2f",
      "name": "Limpar Mensagem",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_firstMessage",
        "value": "={{ $('Set Buffer Mensagens').first().json.messageBuffer }}",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1632,
        1680
      ],
      "id": "86850dfc-f72a-4481-b4ad-fa2d8ef5632c",
      "name": "Primeira Mensagem",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagemAtual",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_message",
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1664,
        64
      ],
      "id": "e8a31909-45bb-4d4e-a3f2-9c0a28bf0e8a",
      "name": "Coletar Mensagem Verificacao",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagemAtual",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_message",
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        784,
        912
      ],
      "id": "d9114516-8250-4b29-9f64-12b6565e0638",
      "name": "Coletar Mensagem Atendimento",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagemAtual",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_message",
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1360,
        1696
      ],
      "id": "40ebe27e-1220-4df3-9f1f-c54bad629f7e",
      "name": "Coletar Mensagem IcoPass",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagemAtual",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_message",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        800,
        2656
      ],
      "id": "7015425f-0b1a-4482-b4ab-c031c3bfded2",
      "name": "Coletar Mensagem Nao Encontrado",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9efad99d-7bde-414c-af1a-637e4d123fb5",
              "name": "inputToken",
              "value": "={{ $('Tratar somente Numeros1').first().json.messageOnlyNumbers }}",
              "type": "string"
            },
            {
              "id": "995dfa0d-2e48-4fb3-9a60-087d76e3c96e",
              "name": "matriculaUsuario",
              "value": "={{ $('Coletar Matricula Usuario').first().json.matricula }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        720,
        1952
      ],
      "id": "06be9b54-b214-4224-89b0-e6f5df86ebe1",
      "name": "Coletar Token",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "matricula",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_matricula",
        "options": {
          "dotNotation": false
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        432,
        1952
      ],
      "id": "df9091e7-0512-435d-b194-5dc60a645adb",
      "name": "Coletar Matricula Usuario",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_nome",
        "value": "={{ $('coletar dados usuario').first().json.dadosCliente.Nome.trim().split(/\\s+/)[0] }}",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -992,
        1968
      ],
      "id": "3416f614-8bd6-4a91-a2e2-eeec15ff9e53",
      "name": "Setar Nome Colaborador",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_matricula",
        "value": "={{ $('coletar dados usuario1').first().json.dadosCliente.Re }}",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1328,
        448
      ],
      "id": "3c01a91b-d742-4dd8-b5a3-3b4669abe4be",
      "name": "Setar Matricula",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_nome",
        "value": "={{ $('coletar dados usuario1').first().json.dadosCliente.Nome.trim().split(/\\s+/)[0] }}",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1104,
        448
      ],
      "id": "0cf48a51-6372-4a0d-9a98-6cdb25581c3a",
      "name": "Setar Nome",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagemInicial",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_firstMessage",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1168,
        2304
      ],
      "id": "5e08329d-b013-4f7e-9ab6-f3f863d0c02d",
      "name": "Resgatar Mensagem Inicial",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_message",
        "value": "={{ $('Resgatar Mensagem Inicial').first().json.mensagemInicial }}",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1424,
        2304
      ],
      "id": "42f75d03-6bc8-464e-8962-98eba05b0a4c",
      "name": "Mensagem atual1",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "nomeUsuario",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_nome",
        "options": {
          "dotNotation": false
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1216,
        912
      ],
      "id": "08590d7a-8cf5-4bbb-9a62-588a936897a2",
      "name": "Coletar Nome Usuario",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b60e9583-6fe9-45ff-ac2f-aadaaa27c51f",
              "name": "session",
              "value": "={{ $('Webhook').first().json.body.data.sender.phone_number }}_{{ $('Webhook').item.json.body.data.sender.name.trim().split(/\\s+/)[0] }}",
              "type": "string"
            },
            {
              "id": "1f37ee26-a963-497c-b693-a14afd0bdff1",
              "name": "chatId",
              "value": "={{ $('Webhook').first().json.body.data.id }}",
              "type": "string"
            },
            {
              "id": "01a74efd-5d4e-4869-b157-8611c12facf8",
              "name": "pushName",
              "value": "={{ $('Webhook').first().json.body.data.sender.name }}",
              "type": "string"
            },
            {
              "id": "36b91569-2721-46ab-b458-6c2c00c1f659",
              "name": "typeMessage",
              "value": "={{ $('Webhook').first().json.body.data.type }}",
              "type": "string"
            },
            {
              "id": "6c3fee67-5a3e-4daf-b7e0-8a987bf24dc1",
              "name": "message",
              "value": "={{ $('Webhook').first().json.body.data.content.text }}",
              "type": "string"
            },
            {
              "id": "112014ec-de53-4924-a50e-d6139d850fcb",
              "name": "recipientLid",
              "value": "={{ $('Webhook').first().json.body.data.recipient.lid }}",
              "type": "string"
            },
            {
              "id": "c06f028b-6543-451e-ab4c-ef99e6feea7d",
              "name": "phoneNumber",
              "value": "={{ $('Tratar n√∫mero').first().json.foneTratado }}",
              "type": "string"
            },
            {
              "id": "82000d21-cf1e-4dec-8320-aa5486956519",
              "name": "message_audio",
              "value": "={{ $('Webhook').first().json.body.data.content.media.url }}",
              "type": "string"
            },
            {
              "id": "7f4e7ff8-3496-4e3a-94ff-885e66647e43",
              "name": "message_image",
              "value": "={{ $('Webhook').first().json.body.data.content.media.url }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4400,
        1472
      ],
      "id": "3f470f38-fced-437d-962f-5853ec8796f7",
      "name": "coletar dados da conversa",
      "executeOnce": true
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "registroAtendimento",
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "keyValue": "={{ $('coletar dados da conversa').first().json.session }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1680,
        688
      ],
      "id": "b97736f6-8079-4262-a955-e815f7d7acf2",
      "name": "Consultar Status1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "registroAtendimento",
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "condition": "eq",
              "keyValue": "={{ $('coletar dados da conversa').first().json.session }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "mensagemAtual",
              "fieldValue": "={{ $('Set Buffer Mensagens').item.json.messageBuffer }}"
            },
            {
              "fieldId": "sessionId",
              "fieldValue": "={{ $('coletar dados da conversa').item.json.session }}"
            },
            {
              "fieldId": "statusAtendimento",
              "fieldValue": "inicio_conversa"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1152,
        624
      ],
      "id": "d461c770-4f6d-44cf-baf9-8a510fc350d5",
      "name": "Update a row",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d5b0308d-48b5-433b-98c7-c9a1d2f41ce6",
              "leftValue": "={{ $json.created_at }}",
              "rightValue": "2",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1472,
        608
      ],
      "id": "8bc659b9-1a7c-46ee-90d8-a339940d2680",
      "name": "If8",
      "alwaysOutputData": false,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('coletar dados da conversa').first().json.session }}_memory",
        "sessionTTL": 1800,
        "contextWindowLength": 40
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        2176,
        272
      ],
      "id": "50f138b8-b21e-41d4-b5cb-c51671ff0ff6",
      "name": "Redis Chat Memory",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('coletar dados da conversa').first().json.session }}_memoryAtendimento",
        "sessionTTL": 1800,
        "contextWindowLength": 40
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        1632,
        1136
      ],
      "id": "6c183ca3-634f-4035-9d5f-5cf34f700554",
      "name": "Redis Chat Memory1",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('coletar dados da conversa').first().json.session }}_memory",
        "sessionTTL": 1800,
        "contextWindowLength": 40
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        1984,
        2096
      ],
      "id": "a5dde1da-790a-4d65-b2b9-47929d0ca11b",
      "name": "Redis Chat Memory2",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('coletar dados da conversa').first().json.session }}_memory",
        "sessionTTL": 1800,
        "contextWindowLength": 40
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        1600,
        3040
      ],
      "id": "64d5698b-98a6-45cf-83b8-be0e76df1700",
      "name": "Redis Chat Memory3",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "content": "Sa√≠da/Resposta Agente",
        "height": 944,
        "width": 1360,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3424,
        1440
      ],
      "typeVersion": 1,
      "id": "94947e47-e743-434b-afb9-7430a73b6c69",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "memoryHist",
        "key": "={{ $('coletar dados da conversa').item.json.session }}_memory",
        "keyType": "list",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        4384,
        1728
      ],
      "id": "9ad4fca2-a551-4a09-9700-750950dca513",
      "name": "Get Memory",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "registroAtendimento",
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "condition": "eq",
              "keyValue": "={{ $('coletar dados da conversa').item.json.session }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "historicoConversa",
              "fieldValue": "={{ $('Get Memory').item.json.memoryHist }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4656,
        1712
      ],
      "id": "1eefa5c5-1dee-468c-8cca-d9ead0abdad7",
      "name": "Historico de Conversa",
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "91cbde0e-dd1d-4b2e-b40f-0bc6153f82a2",
              "name": "mensagemAtual",
              "value": "=<contextoAnaliseToken>\n\n  Descri√ß√£o da mensagem retornada pela API na valida√ß√£o do Token.\n\n  <response>\n    {{ $('API IcoPass').first().json.chatInput }}\n  </response>\n\n  <tokenUsuario>\n\n    {{ $('Coletar Token').first().json.inputToken }}\n\n  </tokenUsuario>\n\n</contextoAnaliseToken>",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1424,
        2128
      ],
      "id": "c2709730-0662-4f4a-9c3f-3ff0cb40b9ea",
      "name": "Retorno API"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagemAtual",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_message",
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        448,
        1712
      ],
      "id": "fd365afc-2377-46d3-a4c0-657c0b259528",
      "name": "Coletar IcoPass Token",
      "alwaysOutputData": false,
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "registroAtendimento",
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "condition": "eq",
              "keyValue": "={{ $('coletar dados da conversa').first().json.session }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "statusAtendimento",
              "fieldValue": "inicio_conversa"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1312,
        1680
      ],
      "id": "9b3841f6-27fe-4cff-83e9-6be51150e1b1",
      "name": "Update a row1",
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -5520,
        1664
      ],
      "id": "56ace2e5-d52a-49b9-ae51-cdc727eabda5",
      "name": "Conversa Telegram",
      "webhookId": "b648ccf3-c019-48ad-86f1-3f826f1c26be",
      "credentials": {
        "telegramApi": {
          "id": "tx60a4WKQalMQHnj",
          "name": "Telegram account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "027e85d7-ad52-4123-9bf3-05ff4dd55c2a",
              "leftValue": "={{ $('Loop Over Items').first().json.message }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3920,
        1888
      ],
      "id": "421857bb-2d99-47de-abcb-30a1cb5c46c6",
      "name": "If2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        4192,
        2096
      ],
      "id": "9baa8ed4-c11d-45cf-838c-cc1faae84147",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensagemInicial",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_firstMessage",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1104,
        672
      ],
      "id": "cc370f1e-14a1-40c3-b2e2-934ecd492b41",
      "name": "Resgatar Mensagem Inicial1",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}_message",
        "value": "={{ $('Resgatar Mensagem Inicial1').first().json.mensagemInicial }}",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1376,
        672
      ],
      "id": "8d802dc8-c8e3-45ff-8790-adfaaff38c94",
      "name": "Mensagem atual2",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        2080,
        2176
      ],
      "id": "3ed1e7ed-2869-4d83-bf5c-78f24cc6ac9f",
      "name": "Calculator1"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}",
        "value": "inicio_conversa",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1472,
        1680
      ],
      "id": "33c22cba-0909-4fa2-bef2-079abe869a0d",
      "name": "Status Inicial",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "statusAtendimento",
        "key": "={{ $('coletar dados da conversa').first().json.session }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -448,
        1600
      ],
      "id": "9fed9b6e-b88a-4731-b3b7-e6ed8dad78ed",
      "name": "Status direcionamento",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}",
        "value": "atendimento",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1200,
        1968
      ],
      "id": "441e6df2-3948-4849-8696-9389b8116051",
      "name": "Status Atendimento",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}",
        "value": "nao_localizado",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        912,
        256
      ],
      "id": "3732436d-5b09-4811-8048-939d2d0d835d",
      "name": "Nao Localizado",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}",
        "value": "acesso_icopass",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1568,
        448
      ],
      "id": "d29f9676-8095-4ae3-b8a1-48be340f3121",
      "name": "Status Icopass",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}",
        "value": "inicio_conversa",
        "expire": true,
        "ttl": 500
      },
      "type": "n8n-nodes-base.redisTool",
      "typeVersion": 1,
      "position": [
        2400,
        2064
      ],
      "id": "f421417e-bd0e-4bc7-acd7-875fcf993abb",
      "name": "Status inicio_conversa",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "registroAtendimento",
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "condition": "eq",
              "keyValue": "={{ $('coletar dados da conversa').first().json.session }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "statusAtendimento",
              "fieldValue": "inicio_conversa"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        2288,
        2144
      ],
      "id": "26f6a423-feba-4da5-a797-ad5c514d2499",
      "name": "Status inicio_conversa1",
      "credentials": {
        "supabaseApi": {
          "id": "Z179aOzdGDkmnopp",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}",
        "value": "atendimento",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        944,
        2304
      ],
      "id": "994dc62a-4edd-42e5-88e6-30cdf7f707b5",
      "name": "Status Atendimento1",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('coletar dados da conversa').first().json.session }}",
        "value": "finalizada",
        "expire": true,
        "ttl": 1800
      },
      "type": "n8n-nodes-base.redisTool",
      "typeVersion": 1,
      "position": [
        1648,
        2864
      ],
      "id": "e9c033de-21c2-4d8e-8aa0-f6b698be17a9",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "uUviyg2VYvUsG0xc",
          "name": "Redis account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Acesso IcoPass",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "AI Nao Localizado",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "coletar identificador": {
      "main": [
        [
          {
            "node": "API Identidade",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "coletar dados usuario": {
      "main": [
        [
          {
            "node": "Dados Colaborador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "coletar identificador",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Coletar Mensagem Verificacao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Tratar n√∫mero",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "Acesso IcoPass",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "coletar dados usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerenciar direcionamento": {
      "main": [
        [
          {
            "node": "Tratar somente Numeros",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Coletar Mensagem Atendimento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Coletar IcoPass Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Coletar Mensagem Nao Encontrado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Coletar Mensagem Nao Encontrado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Coletar Mensagem Nao Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Usuario": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Setar Status Nao Localizado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "coletar dados usuario1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Colaborador N√£o Encontrado": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Atendimento": {
      "ai_languageModel": [
        [
          {
            "node": "AI Nao Localizado",
            "type": "ai_languageModel",
            "index": 1
          },
          {
            "node": "Acesso IcoPass",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Sql Agtesla": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "coletar dados usuario1": {
      "main": [
        [
          {
            "node": "Setar Nome",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Nao Localizado": {
      "ai_tool": [
        [
          {
            "node": "Acesso IcoPass",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Tratar somente Numeros": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Banco Vetorial",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_vectorStore": [
        [
          {
            "node": "Banco Vetorial",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "API Identidade": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If IcoPass": {
      "main": [
        [
          {
            "node": "Coletar Mensagem IcoPass",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Coletar Matricula Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tratar somente Numeros1": {
      "main": [
        [
          {
            "node": "If IcoPass",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API IcoPass": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Retorno API",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Atualizar Dados Atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Banco Vetorial": {
      "ai_tool": [
        [
          {
            "node": "Atendimento",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Coletar Buffer Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Set Buffer Mensagens",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Buffer Mensagens": {
      "main": [
        [
          {
            "node": "Mensagem atual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Msg ID": {
      "main": [
        [
          {
            "node": "Set Buffer Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acesso IcoPass": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Validar Usuario",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Atendimento1": {
      "ai_languageModel": [
        [
          {
            "node": "Validar Usuario",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Think1": {
      "ai_tool": [
        [
          {
            "node": "Validar Usuario",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Think2": {
      "ai_tool": [
        [
          {
            "node": "Colaborador N√£o Encontrado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Colaborador N√£o Encontrado",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Atendimento2": {
      "ai_languageModel": [
        [
          {
            "node": "Colaborador N√£o Encontrado",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Think3": {
      "ai_tool": [
        [
          {
            "node": "Atendimento",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Atendimento3": {
      "ai_languageModel": [
        [
          {
            "node": "Atendimento",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Atendimento",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "Validar Usuario",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "Guardrails",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Guardrails": {
      "main": [
        [],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing1": {
      "main": [
        []
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Mensagem",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensagem Audio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensagem Imagem",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem Audio": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Coletar Msg ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem": {
      "main": [
        [
          {
            "node": "Coletar Msg ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem Imagem": {
      "main": [
        [
          {
            "node": "Analyze image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Coletar Msg ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "Update Registro",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Criar Registro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tratar n√∫mero": {
      "main": [
        [
          {
            "node": "coletar dados da conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Status Nao Localizado": {
      "main": [
        [
          {
            "node": "Nao Localizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar dados Colaborador": {
      "main": [
        [
          {
            "node": "Limpar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Dados Atendimento": {
      "main": [
        [
          {
            "node": "Status Atendimento1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atendimento": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response Message Zapster": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update a row in Supabase1": {
      "ai_tool": [
        [
          {
            "node": "Colaborador N√£o Encontrado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Replace Me",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Buffer Mensagem": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Buffer Mensagem": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Buffer Mensagem": {
      "main": [
        [
          {
            "node": "Consultar Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem atual": {
      "main": [
        [
          {
            "node": "Delete Buffer Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Status": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Registro": {
      "main": [
        [
          {
            "node": "Primeira Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados Colaborador": {
      "main": [
        [
          {
            "node": "Status Atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Registro": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar Mensagem": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Primeira Mensagem": {
      "main": [
        [
          {
            "node": "Status Inicial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Mensagem Verificacao": {
      "main": [
        [
          {
            "node": "Validar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Mensagem Atendimento": {
      "main": [
        [
          {
            "node": "Coletar Nome Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Mensagem IcoPass": {
      "main": [
        [
          {
            "node": "Acesso IcoPass",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Mensagem Nao Encontrado": {
      "main": [
        [
          {
            "node": "Colaborador N√£o Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Token": {
      "main": [
        [
          {
            "node": "API IcoPass",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Matricula Usuario": {
      "main": [
        [
          {
            "node": "Coletar Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Nome Colaborador": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Matricula": {
      "main": [
        [
          {
            "node": "Status Icopass",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar Nome": {
      "main": [
        [
          {
            "node": "Setar Matricula",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resgatar Mensagem Inicial": {
      "main": [
        [
          {
            "node": "Mensagem atual1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem atual1": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar Nome Usuario": {
      "main": [
        [
          {
            "node": "Atendimento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "coletar dados da conversa": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Status1": {
      "main": [
        []
      ]
    },
    "If8": {
      "main": [
        [],
        []
      ]
    },
    "Update a row": {
      "main": [
        []
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Validar Usuario",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "Atendimento",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory2": {
      "ai_memory": [
        [
          {
            "node": "Acesso IcoPass",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory3": {
      "ai_memory": [
        [
          {
            "node": "Colaborador N√£o Encontrado",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Get Memory": {
      "main": [
        [
          {
            "node": "Historico de Conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Historico de Conversa": {
      "main": [
        []
      ]
    },
    "Retorno API": {
      "main": [
        [
          {
            "node": "Acesso IcoPass",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Coletar IcoPass Token": {
      "main": [
        [
          {
            "node": "Tratar somente Numeros1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update a row1": {
      "main": [
        [
          {
            "node": "Sql Agtesla",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Conversa Telegram": {
      "main": [
        []
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Response Message Zapster",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resgatar Mensagem Inicial1": {
      "main": [
        [
          {
            "node": "Mensagem atual2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem atual2": {
      "main": [
        [
          {
            "node": "Status direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculator1": {
      "ai_tool": [
        [
          {
            "node": "Acesso IcoPass",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Status Inicial": {
      "main": [
        [
          {
            "node": "Update a row1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status direcionamento": {
      "main": [
        [
          {
            "node": "Gerenciar direcionamento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Atendimento": {
      "main": [
        [
          {
            "node": "Setar Nome Colaborador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Nao Localizado": {
      "main": [
        [
          {
            "node": "Limpar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Icopass": {
      "main": [
        [
          {
            "node": "Registrar dados Colaborador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status inicio_conversa": {
      "ai_tool": [
        [
          {
            "node": "AI Nao Localizado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Status inicio_conversa1": {
      "ai_tool": [
        [
          {
            "node": "AI Nao Localizado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Status Atendimento1": {
      "main": [
        [
          {
            "node": "Resgatar Mensagem Inicial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "ai_tool": [
        [
          {
            "node": "Colaborador N√£o Encontrado",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "52e24972-4036-4e2c-891f-20834eb96a13",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c13cee92dfa69db8294a82c6dfa57e3a1199207e843eec919de3f2ec003607aa"
  },
  "id": "Jigl1UburULdx8ub",
  "tags": [
    {
      "updatedAt": "2025-12-02T17:44:17.488Z",
      "createdAt": "2025-12-01T14:07:28.553Z",
      "id": "l1WJO2gYoiZjBRpa",
      "name": "agent-ia"
    },
    {
      "updatedAt": "2025-12-02T17:43:42.671Z",
      "createdAt": "2025-12-02T17:43:42.671Z",
      "id": "DAVqu1ffZ94tmOAL",
      "name": "prod"
    }
  ]
}